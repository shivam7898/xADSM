# Unsupervised Learning (B18, Nov-07) {#b18}

```{r 'B18', include=FALSE, cache=FALSE}
sys.source(paste0(.z$RX, "A99Knitr", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "000Packages", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "A00AllUDF", ".R"), envir = knitr::knit_global())
#invisible(lapply(f_getPathR(A09isPrime), knitr::read_chunk))
```


## Overview

- "Unsupervised Learning Algorithms"
  - "ForLater"
  - Case Analysis of JAT is Merged in notes of [Case Study: JAT](#jat-b15 "b15")
  - NOTE: Discussion about Jupyter Notebook & Anaconda Navigator "15:45 - 16:05" is NOT covered because I am not working with it.
  - NOTE: Package 'esquisse' was not used because interactive is difficult to show in document format. "16:15 - 16:30"

## Install

```{r 'B18-Installations', eval=FALSE}
if(FALSE){# #WARNING: Installation may take some time.
  install.packages("esquisse", dependencies = TRUE)
}
```

## Data: Churn

\textcolor{pink}{Please import the "B18-Churn.xlsx".}

```{r 'B18-Churn', include=FALSE, eval=FALSE}
# #Path of Object, FileName and MD5Sum
#tools::md5sum(paste0(.z$XL, "B18-Churn.xlsx"))
xxB18ChurnXL <- f_getObject("xxB18ChurnXL", "B18-Churn.xlsx", "d20730cb7050db29691eda7ca536c914")
xxB18Churn <- xxB18ChurnXL[[1]]
f_setRDS(xxB18Churn)
```

```{r 'B18-getChurn', include=FALSE}
# #Load Data: Churn
xxB18Churn <- f_getRDS(xxB18Churn)
bb <- aa <- xxB18Churn
```

## Q1 {.tabset .tabset-fade}

- Explore whether there are missing values for any of the variables.
  - There are NO missing values

### Transposed Churn {.unlisted .unnumbered}

```{r 'B18-Transposed', include=FALSE}
# #Transposed and Filtered Data
t_aa <- aa[1:6, ] %>% 
  mutate(Row_Col = paste0("Row_", row_number())) %>% 
  relocate(Row_Col) %>% 
  mutate(across(!where(is.character), as.character)) %>% 
  `attr<-`("ColsLost", unlist(strsplit(names(.)[1], "_"))[1]) %>% 
  `attr<-`("RowsKept", unlist(strsplit(names(.)[1], "_"))[2]) %>% 
  pivot_longer(c(-1), 
               names_to = paste0(attributes(.)$RowsKept, "_", attributes(.)$ColsLost), 
               values_to = "Values") %>% 
  pivot_wider(names_from = 1, values_from = Values) %>% 
  `attr<-`("ColsLost", NULL) %>% `attr<-`("RowsKept", NULL)
```

```{r 'B18T02', echo=FALSE}
bb <- t_aa
kbl(bb,
  caption = "(B18T02) Churn Transposed",
  #col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	)
```

### Churn Data {.unlisted .unnumbered}

```{r 'B18T01', echo=FALSE}
bb <- head(aa)
kbl(bb,
  caption = "(B18T01) Churn",
  #col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	)
```

### NA {.unlisted .unnumbered}

```{r 'B18-NA'}
anyNA(bb)
```

## Q2 {.tabset .tabset-fade}

- Compare the area code and state fields. Discuss any apparent abnormalities.
  - There are only 3 Area Codes and all of them belong to California State.

### States Bar Chart {.unlisted .unnumbered}

```{r 'B18-Q2', include=FALSE}
# #Select | Rename 
bb <- aa %>% select(`Area Code`, State) %>% rename(Area = "Area Code") 
# #Select | Group | Frequency | Descending   
ii <- bb %>% select(State) %>% group_by(State) %>% summarise(CNT = n()) %>% arrange(desc(CNT)) %>% 
     mutate(across(State, factor, levels = rev(unique(State)), ordered = TRUE))
```

```{r 'B18-StatesBar', include=FALSE}
# #Proper Sorting of Factors for Flipped Axes
hh <- ii %>% mutate(nState = as.integer(State))
# #Because the CNT have duplicated values ggplot would add them up if used on x-axis
anyDuplicated(ii$CNT)
# #So, place it on Y-axis and then flip the axis
#
# #Set Alternate Labels as blanks on both Primary and Secondary x-axis
#x_sec <- x_prim <- as.character(hh$State)
#x_prim[1:nrow(hh) %%2 != 1] <- ""
#x_sec[1:nrow(hh) %%2 == 1] <- ""
#
# #Get Median Location
#hh %>% filter(CNT == median(CNT)) %>% mutate(as.integer(State))
median_loc_hh <- ceiling(nrow(hh)/2) 
#
caption_hh <- "B18P01"
title_hh <- "Churn: Frequency of States"
subt_hh <- paste0(nrow(hh), " States with Median = ",  median(hh$CNT)) #NULL
#
B18 <- hh %>% { ggplot(data = ., aes(x = nState, y = CNT)) +
    geom_bar(stat = 'identity', aes(fill = (nState %% 2 == 0))) + 
    geom_vline(aes(xintercept = median_loc_hh), color = '#440154FF') +
    scale_x_continuous( #sec.axis = sec_axis(~., breaks = 1:nrow(.), labels = rev(.$State)), 
      breaks = 1:nrow(.), guide = guide_axis(n.dodge = 2), labels = rev(.$State)) + 
    k_gglayer_bar + 
    coord_flip() +
    labs(x = "State", y = "Frequency", subtitle = subt_hh, 
         caption = caption_hh, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P01-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P01","_Churn_States_Bar", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P01)
```

```{r 'B18P01', echo=FALSE, fig.cap="Churn: States Frequency"}
knitr::include_graphics(paste0(.z$PX, "B18P01","_Churn_States_Bar", ".png"))
```

### Exploration {.unlisted .unnumbered}

```{r 'B18-Q2-A', ref.label=c('B18-Q2'), eval=FALSE}
#
```

### State & Area {.unlisted .unnumbered}

```{r 'B18-Area'}
ii <- bb %>% mutate(across(everything(), factor))
#
# #Unique Values
ii %>% summarise(across(everything(), ~ length(unique(.))))
#
summary(ii)
#
str(levels(ii$Area))
str(levels(ii$State))
```

### Code Bar Chart {.unlisted .unnumbered}

```{r 'B18-StatesBar-A', ref.label=c('B18-StatesBar'), eval=FALSE}
#
```

## Q3 

- Use useful graphs to visually determine whether there are any outliers in the datasets (Note: check the same for all the numeric variables).
  - Histograms 
  - QQ Plots
  - Box Plots

```{r 'B18-Q3', include=FALSE}
# #Rename to Proper Names | To Lower, Replace by Underscore | Coercion 
bb <- aa %>% rename_with(make.names) %>% 
  rename_with(~ tolower(gsub(".", "_", .x, fixed = TRUE))) %>% 
  mutate(across(c(int_l_plan, vmail_plan), ~case_when(. == "yes" ~ TRUE, . == "no" ~ FALSE))) %>% 
  mutate(across(churn, ~case_when(. == "True." ~ TRUE, . == "False." ~ FALSE))) %>% 
  mutate(across(ends_with("_calls"), as.integer))
#t(bb %>% summarise(across(everything(), ~length(unique(.)))))
#str(bb)
#summary(bb)
```

### All Histograms {.tabset .tabset-fade} 

#### Image {.unlisted .unnumbered}

```{r 'B18-AllNumeric', include=FALSE}
ii <- bb %>% 
  select(where(is.numeric)) %>% 
  select(!area_code) %>% 
  relocate(ends_with("_mins")) %>% 
  relocate(ends_with("_calls")) %>% 
  relocate(vmail_message, .after =  last_col()) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key))))
#
str(ii)
```

```{r 'B18-AllHistograms', include=FALSE}
# #Histogram
hh <- ii
title_hh <- "Churn: Histograms"
caption_hh <- "B18P03"
#
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = Values)) + 
    geom_histogram(bins = ifelse(length(unique(.[[1]])) > 50, 50, length(unique(.[[1]]))),
                   alpha = 0.4, fill = '#FDE725FF') + 
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white")) +
    facet_wrap(~Key, nrow = 3, scales = 'free') +
    labs(x = "x", y = NULL, caption = caption_hh, subtitle = NULL, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P03-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P03","_Churn_All_Hist", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P03, width = k_width, height = k_height)
```

```{r 'B18P03', echo=FALSE, fig.cap="Churn: All Histograms", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P03","_Churn_All_Hist", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'B18-AllHistograms-A', ref.label=c('B18-AllNumeric', 'B18-AllHistograms'), eval=FALSE}
#
```


### All QQ Plots {.tabset .tabset-fade} 

#### Image {.unlisted .unnumbered}

```{r 'B18-AllQQ', include=FALSE}
# #QQ Plots
hh <- ii
title_hh <- "Churn: QQ Plots"
caption_hh <- "B18P04"
#
B18 <- hh %>% { ggplot(., aes(sample = Values)) +
    stat_qq() +
    stat_qq_line() +
    facet_wrap(~Key, nrow = 3, scales = 'free_y') +
    #scale_x_continuous(limits = c(-3, 3)) + 
    #coord_flip() +
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white")) +
    labs(x = "x", y = NULL, caption = caption_hh, subtitle = NULL, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P04-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P04","_Churn_All_QQ", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P04, width = k_width, height = k_height)
```

```{r 'B18P04', echo=FALSE, fig.cap="Churn: All QQ Plots", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P04","_Churn_All_QQ", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'B18-AllQQ-A', ref.label=c('B18-AllQQ'), eval=FALSE}
#
```

### 9 Box Plots {.tabset .tabset-fade} 

#### Image {.unlisted .unnumbered}

```{r 'B18-AllBoxData', include=FALSE}
# #Data
jj_calls <- bb %>% select(day_calls, eve_calls, night_calls) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key))))
#
jj_mins <- bb %>% select(day_mins, eve_mins, night_mins) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key))))
#
jj_charge <- bb %>% select(day_charge, eve_charge, night_charge) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key))))
```

```{r 'B18-BoxCalls', include=FALSE, eval=FALSE}
# #Box Plots
hh <- jj_calls
title_hh <- "Churn: Calls"
caption_hh <- "B18P05"
```

```{r 'B18-BoxCalls-A', include=FALSE, ref.label=c('B18-BoxCalls', 'B18-BoxPlot')}
#
```

```{r 'B18P05-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P05","_Churn_Box_Calls", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P05)
```

```{r 'B18P05', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P05","_Churn_Box_Calls", ".png"))
```

```{r 'B18-BoxMins', include=FALSE, eval=FALSE}
# #Box Plots
hh <- jj_mins
title_hh <- "Churn: Minutes"
caption_hh <- "B18P06"
```

```{r 'B18-BoxMins-A', include=FALSE, ref.label=c('B18-BoxMins', 'B18-BoxPlot')}
#
```

```{r 'B18P06-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P06","_Churn_Box_Mins", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P06)
```

```{r 'B18P06', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P06","_Churn_Box_Mins", ".png"))
```

```{r 'B18-BoxCharges', include=FALSE, eval=FALSE}
# #Box Plots
hh <- jj_charge
title_hh <- "Churn: Charges"
caption_hh <- "B18P07"
```

```{r 'B18-BoxCharges-A', include=FALSE, ref.label=c('B18-BoxCharges', 'B18-BoxPlot')}
#
```

```{r 'B18P07-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P07","_Churn_Box_Charges", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P07)
```

```{r 'B18P07', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P07","_Churn_Box_Charges", ".png"))
```

```{r 'B18P050607', echo=FALSE, ref.label=c('B18P05', 'B18P06', 'B18P07'), fig.cap="Churn: BoxPlots of Calls, Minutes, & Charges", out.width='33%'}
#
```

#### Code {.unlisted .unnumbered}

```{r 'B18-BoxPlot', eval=FALSE}
# #BoxPlot
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = Key, y = Values, fill = Key)) +
    geom_boxplot() +
    k_gglayer_box +
    theme(legend.position = 'none') +
    labs(x = NULL, y = NULL, caption = caption_hh, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

### International Calls Box Plots {.tabset .tabset-fade} 

#### Image {.unlisted .unnumbered}

```{r 'B18-BoxiCalls', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$intl_calls)
title_hh <- "Churn: International Calls"
caption_hh <- "B18P08"
```

```{r 'B18-BoxiCalls-A', include=FALSE, ref.label=c('B18-BoxiCalls', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P08-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P08","_Churn_Box_iCalls", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P08)
```

```{r 'B18P08', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P08","_Churn_Box_iCalls", ".png"))
```

```{r 'B18-BoxiMins', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$intl_mins)
title_hh <- "Churn: International Minutes"
caption_hh <- "B18P09"
```

```{r 'B18-BoxiMins-A', include=FALSE, ref.label=c('B18-BoxiMins', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P09-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P09","_Churn_Box_iMins", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P09)
```

```{r 'B18P09', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P09","_Churn_Box_iMins", ".png"))
```

```{r 'B18-BoxiCharges', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$intl_charge)
title_hh <- "Churn: International Charges"
caption_hh <- "B18P10"
```

```{r 'B18-BoxiCharges-A', include=FALSE, ref.label=c('B18-BoxiCharges', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P10-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P10","_Churn_Box_iCharges", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P10)
```

```{r 'B18P10', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P10","_Churn_Box_iCharges", ".png"))
```

```{r 'B18P080910', echo=FALSE, ref.label=c('B18P08', 'B18P09', 'B18P10'), fig.cap="Churn: BoxPlots of International Calls, Minutes, & Charges", out.width='33%'}
#
```



#### Code {.unlisted .unnumbered}

```{r 'B18-SingleBoxPlot', eval=FALSE}
# #BoxPlot
B18 <- hh %>% { ggplot(data = ., mapping = aes(y = Values)) +
    geom_boxplot() +
    k_gglayer_box +
    theme(legend.position = 'none') +
    labs(x = NULL, y = NULL, caption = caption_hh, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

### 3 Box Plots 

```{r 'B18-BoxAcc', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$account_length)
title_hh <- "Churn: Account Length"
caption_hh <- "B18P11"
```

```{r 'B18-BoxAcc-A', include=FALSE, ref.label=c('B18-BoxAcc', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P11-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P11","_Churn_Box_ACC", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P11)
```

```{r 'B18P11', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P11","_Churn_Box_ACC", ".png"))
```

```{r 'B18-BoxVmail', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$vmail_message)
title_hh <- "Churn: Voice Messages"
caption_hh <- "B18P12"
```

```{r 'B18-BoxVmail-A', include=FALSE, ref.label=c('B18-BoxVmail', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P12-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P12","_Churn_Box_Vmail", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P12)
```

```{r 'B18P12', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P12","_Churn_Box_Vmail", ".png"))
```

```{r 'B18-BoxCustomer', include=FALSE, eval=FALSE}
# #Box Plots
hh <- tibble(Values = bb$custserv_calls)
title_hh <- "Churn: Customer Service Calls"
caption_hh <- "B18P13"
```

```{r 'B18-BoxCustomer-A', include=FALSE, ref.label=c('B18-BoxCustomer', 'B18-SingleBoxPlot')}
#
```

```{r 'B18P13-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P13","_Churn_Box_iCharges", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P13)
```

```{r 'B18P13', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "B18P13","_Churn_Box_iCharges", ".png"))
```

```{r 'B18P111213', echo=FALSE, ref.label=c('B18P11', 'B18P12', 'B18P13'), fig.cap="Churn: BoxPlots of Reamining Three", out.width='33%'}
#
```

### International Calls {.tabset .tabset-fade}


#### Image {.unlisted .unnumbered}

```{r 'B18-Histogram', include=FALSE}
# #Histogram
hh <- tibble(ee = bb$intl_calls)
title_hh <- "Churn: Histogram of International Calls"
caption_hh <- "B18P02"
# #Bins
summary(hh[[1]])
bins_hh <- ifelse(length(unique(hh[[1]])) > 50, 50, length(unique(hh[[1]])))
# #Basics
median_hh <- round(median(hh[[1]]), 1)
mean_hh <- round(mean(hh[[1]]), 1)
sd_hh <- round(sd(hh[[1]]), 1)
len_hh <- nrow(hh)
#
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = ee)) + 
  geom_histogram(bins = bins_hh, alpha = 0.4, fill = '#FDE725FF') + 
  geom_vline(aes(xintercept = mean_hh), color = '#440154FF') +
  geom_text(data = tibble(x = mean_hh, y = -Inf, 
                          label = paste0("Mean= ", mean_hh)), 
            aes(x = x, y = y, label = label), 
            color = '#440154FF', hjust = -0.5, vjust = 1.3, angle = 90) +
  geom_vline(aes(xintercept = median_hh), color = '#3B528BFF') +
  geom_text(data = tibble(x = median_hh, y = -Inf, 
                          label = paste0("Median= ", median_hh)), 
            aes(x = x, y = y, label = label), 
            color = '#3B528BFF', hjust = -0.5, vjust = -0.7, angle = 90) +
  theme(plot.title.position = "panel") + 
  labs(x = "x", y = "Frequency", 
       subtitle = paste0("(N=", len_hh, "; ", "Mean= ", mean_hh, 
                         "; Median= ", median_hh, "; SD= ", sd_hh,
                         ")"), 
        caption = caption_hh, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P02-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P02","_Churn_iCalls_Hist", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P02)
```

```{r 'B18P02', echo=FALSE, fig.cap="Churn: International Calls"}
knitr::include_graphics(paste0(.z$PX, "B18P02","_Churn_iCalls_Hist", ".png"))
```

#### Exploration {.unlisted .unnumbered}

```{r 'B18-Q3-A', ref.label=c('B18-Q3'), eval=FALSE}
#
```

#### Code {.unlisted .unnumbered}

```{r 'B18-Histogram-A', ref.label=c('B18-Histogram'), eval=FALSE}
#
```

### Scale 

```{r 'B18-DepCheck01', include=FALSE, eval=FALSE}
#cat(paste0(names(bb), collapse = ", "), "\n")
#str(bb)
#tibble [3,333 x 21] (S3: tbl_df/tbl/data.frame)
# $ state         : chr [1:3333] "KS" "OH" "NJ" "OH" ...
# $ account_length: num [1:3333] 128 107 137 84 75 118 121 147 117 141 ...
# $ area_code     : num [1:3333] 415 415 415 408 415 510 510 415 408 415 ...
# $ phone         : chr [1:3333] "382-4657" "371-7191" "358-1921" "375-9999" ...
# $ int_l_plan    : logi [1:3333] FALSE FALSE FALSE TRUE TRUE TRUE ...
# $ vmail_plan    : logi [1:3333] TRUE TRUE FALSE FALSE FALSE FALSE ...
# $ vmail_message : num [1:3333] 25 26 0 0 0 0 24 0 0 37 ...
# $ day_mins      : num [1:3333] 265 162 243 299 167 ...
# $ day_calls     : int [1:3333] 110 123 114 71 113 98 88 79 97 84 ...
# $ day_charge    : num [1:3333] 45.1 27.5 41.4 50.9 28.3 ...
# $ eve_mins      : num [1:3333] 197.4 195.5 121.2 61.9 148.3 ...
# $ eve_calls     : int [1:3333] 99 103 110 88 122 101 108 94 80 111 ...
# $ eve_charge    : num [1:3333] 16.78 16.62 10.3 5.26 12.61 ...
# $ night_mins    : num [1:3333] 245 254 163 197 187 ...
# $ night_calls   : int [1:3333] 91 103 104 89 121 118 118 96 90 97 ...
# $ night_charge  : num [1:3333] 11.01 11.45 7.32 8.86 8.41 ...
# $ intl_mins     : num [1:3333] 10 13.7 12.2 6.6 10.1 6.3 7.5 7.1 8.7 11.2 ...
# $ intl_calls    : int [1:3333] 3 3 5 7 3 6 7 6 4 5 ...
# $ intl_charge   : num [1:3333] 2.7 3.7 3.29 1.78 2.73 1.7 2.03 1.92 2.35 3.02 ...
# $ custserv_calls: int [1:3333] 1 1 0 2 3 0 3 0 1 0 ...
# $ churn         : logi [1:3333] FALSE FALSE FALSE FALSE FALSE FALSE ...
```

```{r 'B18-Scale', include=FALSE}
ii <- bb %>% 
  select(where(is.numeric)) %>% 
  select(!area_code) %>% 
  relocate(ends_with("_mins")) %>% 
  relocate(ends_with("_calls")) %>% 
  relocate(vmail_message, .after =  last_col()) 
#
jj <- ii %>% mutate(across(everything(), ~ as.vector(scale(.)))) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key))))
```


#### Histograms {.unlisted .unnumbered}

```{r 'B18-HistScale', include=FALSE}
# #Histogram 
hh <- jj
title_hh <- "Churn: Histograms (Scaled)"
caption_hh <- "B18P14"
#
# #x-axis has been kept free to identify which plots have outliers
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = Values)) + 
    geom_histogram(bins = ifelse(length(unique(.[[1]])) > 50, 50, length(unique(.[[1]]))),
                   alpha = 0.4, fill = '#FDE725FF') + 
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white")) +
    facet_wrap(~Key, nrow = 3, scales = 'free') +
    labs(x = "z", y = NULL, caption = caption_hh, subtitle = NULL, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P14-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P14","_Churn_Scale_Hist", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P14, width = k_width, height = k_height)
```

```{r 'B18P14', echo=FALSE, fig.cap="Churn: All Histograms (Scaled)", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P14","_Churn_Scale_Hist", ".png"))
```

#### QQ Plots {.unlisted .unnumbered}

```{r 'B18-QQScale', include=FALSE}
# #QQ Plots
hh <- jj
title_hh <- "Churn: QQ Plots (Scaled)"
caption_hh <- "B18P15"
#
B18 <- hh %>% { ggplot(., aes(sample = Values)) +
    stat_qq() +
    stat_qq_line() +
    facet_wrap(~Key, nrow = 3, scales = 'free_y') +
    #scale_x_continuous(limits = c(-3, 3)) + 
    #coord_flip() +
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white")) +
    labs(x = "z", y = NULL, caption = caption_hh, subtitle = NULL, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P15-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P15","_Churn_Scale_QQ", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P15, width = k_width, height = k_height)
```

```{r 'B18P15', echo=FALSE, fig.cap="Churn: All QQ Plots (Scaled)", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P15","_Churn_Scale_QQ", ".png"))
```

#### BoxPlots {.unlisted .unnumbered}

```{r 'B18-ScaleBox', include=FALSE}
# #Box Plots
kk <- jj %>% mutate(Group = case_when(str_detect(Key, "day_") ~ "Day", 
                                      str_detect(Key, "night_") ~ "Night", 
                                      str_detect(Key, "eve_") ~ "Eve", 
                                      str_detect(Key, "intl_") ~ "Intl", 
                                      str_detect(Key, "custserv_") ~ "Service", 
                                      str_detect(Key, "account_") ~ "Account", 
                                      str_detect(Key, "vmail_") ~ "Vmail"))
#
hh <- kk
title_hh <- "Churn: BoxPlots (Scaled)"
caption_hh <- "B18P16"
#
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = Key, y = Values, fill = Group)) +
    geom_boxplot() +
    k_gglayer_box +
    coord_flip() +
    theme(legend.position = 'none') +
    labs(x = NULL, y = NULL, caption = caption_hh, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P16-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P16","_Churn_Scale_Box", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P16, width = k_width, height = k_height)
```

```{r 'B18P16', echo=FALSE, fig.cap="Churn: All Box Plots (Scaled)", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P16","_Churn_Scale_Box", ".png"))
```

### Overlaid Histograms

```{r 'B18-Overlaid', include=FALSE}
# #Scaled Data was NOT useful. Original Data had distinguished features
ii <- bb %>% select(matches('day_|night_|eve_')) %>% 
  #mutate(across(everything(), ~ as.vector(scale(.)))) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, ~ factor(., levels = unique(Key)))) %>% 
  mutate(Group = case_when(str_detect(Key, "day_") ~ "Day", 
                           str_detect(Key, "night_") ~ "Night", 
                           str_detect(Key, "eve_") ~ "Eve")) %>% 
  mutate(Facets = case_when(str_detect(Key, "_mins") ~ "Minutes", 
                           str_detect(Key, "_calls") ~ "Calls", 
                           str_detect(Key, "_charge") ~ "Charges"))
```

```{r 'B18-HistOverlaid', include=FALSE}
# #Histogram
hh <- ii
title_hh <- "Churn: Multi Histograms of Day, Eve, Night"
caption_hh <- "B18P17"
#
B18 <- hh %>% { ggplot(data = ., mapping = aes(x = Values, fill = Group)) + 
    geom_histogram(position = "identity", bins = 80, alpha = 0.4) + 
    facet_wrap(~Facets, scales = 'free') +
    scale_fill_viridis_d() +
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white"), 
          #legend.justification = c("right", "top"),
          #legend.box.just = "right",
          #legend.margin = margin(6, 6, 6, 6),
          legend.position = c(.5, .95),
          #legend.position = "bottom", 
          legend.box = "horizontal", 
          legend.direction = "horizontal") +
    labs(x = "x", y = NULL, fill = NULL, caption = caption_hh, subtitle = NULL, title = title_hh)
}
assign(caption_hh, B18)
rm(B18)
```

```{r 'B18P17-Save', include=FALSE}
loc_png <- paste0(.z$PX, "B18P17","_Churn_mHist_Charges", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = B18P17, width = k_width, height = k_height)
```

```{r 'B18P17', echo=FALSE, fig.cap="Churn: All Histograms", out.width='100%'}
knitr::include_graphics(paste0(.z$PX, "B18P17","_Churn_mHist_Charges", ".png"))
```

## Q4 

-	Identify the outliers, using:
  - The Z-score method $z \notin [-3, +3] \to \text{Outlier}$
  - The IQR method
  - Shown Above


## Validation {.unlisted .unnumbered .tabset .tabset-fade}

```{r 'B18-Cleanup', include=FALSE, cache=FALSE}
f_rmExist(aa, bb, ii, jj, kk, ll, t_aa, xxB18Churn, B18P01, B18P02, B18P03, B18P04, B18P05, 
          B18P06, B18P07, bins_hh, caption_hh, hh, jj_calls, jj_charge, jj_mins, len_hh, loc_png, 
          mean_hh, median_hh, median_loc_hh, sd_hh, subt_hh, title_hh, B18P08, B18P09, B18P10, 
          B18P11, B18P12, B18P13, B18P14, B18P15, B18P16, B18P17)
```

```{r 'B18-Validation', include=FALSE, cache=FALSE}
# #SUMMARISED Packages and Objects (BOOK CHECK)
f_()
#
difftime(Sys.time(), k_start)
```

****

# Linear Regression (F66) {#f66}

```{r 'F66', include=FALSE, cache=FALSE}
sys.source(paste0(.z$RX, "A99Knitr", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "000Packages", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "A00AllUDF", ".R"), envir = knitr::knit_global())
#invisible(lapply(f_getPathR(A09isPrime), knitr::read_chunk))
```

## Data: Boston

- About: ISLR2::Boston [506, 13]
  - ISLR2::Boston vs. MASS::Boston
  - MASS has 1 extra column 'black'
  - For now, ISLR2 is being used because the book is using that.


```{r 'F66-DataBoston-AsBS'}
xfw <- bb <- aa <- as_tibble(ISLR2::Boston) #xxxx
```

### Simple Linear Regression

- With medv as resonse and lstat as predictor

- \textcolor{pink}{lm()} for linear regression
  - \textcolor{pink}{summary()} for coefficients
- \textcolor{pink}{confint()} for Confidence Interval
- \textcolor{pink}{predict()} can provide confidence intervals and prediction intervals for given value


```{r 'F66-Reg-SimpleLinear-BS'}
# #Simple Linear Regression 
mod_xfw <- lm(medv ~ lstat, data = xfw)
mod_boston_lm_lstat <- mod_xfw
#
if(FALSE) f_pNum(summary(mod_xfw)$coefficients) %>% as_tibble(rownames = "DummyParVsRef") %>% 
  rename(pVal = "Pr(>|t|)") %>% 
  mutate(pVal = ifelse(pVal < 0.001, 0, pVal), isSig = ifelse(pVal < 0.05, TRUE, FALSE))
#
if(FALSE) names(mod_xfw$coefficients)
#
# #confint() for Confidence Interval
confint(mod_xfw)
#
# #predict() for confidence intervals (95%)
predict(mod_xfw, tibble(lstat = c(5, 10, 15)), interval = "confidence")
#
# #predict() for prediction intervals (95%)
predict(mod_xfw, tibble(lstat = c(5, 10, 15)), interval = "prediction")
#
# #Save Results
res_xfw <- xfw 
#
# #Save the Predicted Values
res_xfw$hatY <- predict(mod_xfw)
#
# #Save the Residuals
res_xfw$resY <- residuals(mod_xfw)
```

### Basic 4 Plots {.tabset .tabset-fade}

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-Plots-Base-Set', include=FALSE}
# #Setup for Base 4 Plots of Model
hh <- mod_xfw
#
cap_hh <- "F66P01"
ttl_hh <- "Boston: Simple Linear Regression of X (lstat) vs. Y (medv)"
loc_png <- paste0(.z$PX, "F66P01", "-Boston-lm-1x-lstat", ".png")
```

```{r 'F66P01-Save', include=FALSE, ref.label=c('F66-Plot-Model')}
#
```

```{r 'F66P01', echo=FALSE, fig.cap="(F66P01) Boston: Simple Linear Regression of X (lstat) vs. Y (medv)"}
knitr::include_graphics(paste0(.z$PX, "F66P01", "-Boston-lm-1x-lstat", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-Plots-Base-Set-A', eval=FALSE, ref.label=c('F66-BS-Plots-Base-Set')}
#
```

```{r 'F66-Plot-Model', eval=FALSE}
# #IN: ttl_hh, cap_hh, hh <- mod_xfw
#
if(!file.exists(loc_png)) {
  png(filename = loc_png) 
  #dev.control('enable') 
  par(mfrow = c(2, 2))
  plot(hh)
  title(main = ttl_hh, line = -2, adj = 0, outer = TRUE)
  title(sub = cap_hh, line = 4, adj = 1)
  F66 <- recordPlot()
  dev.off()
  assign(cap_hh, F66)
  rm(F66)
}
```


### Residual Plot of Single X {.tabset .tabset-fade}

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-Residuals-1-Set', include=FALSE}
# #Setup for Residuals Plot of lm()
hh <- res_xfw %>% select(Response = medv, X = lstat, hatY, resY)
#
cap_hh <- "F66P02"
ttl_hh <- "Boston: Simple Linear Regression of X (lstat) vs. Y (medv)"
sub_hh <- "Large residuals at edges, Small at Centre: Non-linearity! Quadratic!"
```

```{r 'F66-BS-Residuals-1-Plot', include=FALSE, ref.label=c('F66-Plot-Residuals-Single')}
#
```

```{r 'F66P02-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P02", "-Boston-lm-1x-lstat-Residuals", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P02, device = "png", dpi = 144) 
}
```

```{r 'F66P02', echo=FALSE, fig.cap="(F66P02) Boston: Residuals of Simple Linear Regression of X (lstat) vs. Y (medv)"}
knitr::include_graphics(paste0(.z$PX, "F66P02", "-Boston-lm-1x-lstat-Residuals", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-Residuals-1-Set-A', eval=FALSE, ref.label=c('F66-BS-Residuals-1-Set')}
#
```

```{r 'F66-Plot-Residuals-Single', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (X, Y, hatY, resY)
F66 <- hh %>% { ggplot(data = ., mapping = aes(x = X, y = Response)) +
    geom_smooth(formula = 'y ~ x', method = "lm", se = FALSE, color = "#440154FF") +
    geom_segment(aes(xend = X, yend = hatY), alpha = 0.2) +
    geom_point(aes(color = abs(resY)), size = 1) + 
    #geom_point(aes(y = hatY), shape = 1, size = 1) + 
    scale_colour_distiller(palette = "BrBG") + 
    scale_y_continuous(breaks = breaks_pretty()) + 
    scale_x_continuous(breaks = breaks_pretty()) + 
    theme(panel.grid = element_blank()) +
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
```


### Multiple Linear Regression {.tabset .tabset-fade}

- With medv as resonse 

- \textcolor{pink}{augment()}
  - .cooksd, .fitted, .hat, .lower, .resid, .se.fit, .sigma, .std.resid, .upper 

```{r 'F66-Reg-Linear-BS'}
# #Multiple Linear Regression #xxxx
mod_xfw <- lm(medv ~ ., data = xfw)
mod_boston_lm <- mod_xfw
#
if(FALSE) f_pNum(summary(mod_xfw)$coefficients) %>% as_tibble(rownames = "DummyParVsRef") %>% 
  rename(pVal = "Pr(>|t|)") %>% 
  mutate(pVal = ifelse(pVal < 0.001, 0, pVal), isSig = ifelse(pVal < 0.05, TRUE, FALSE))
#
if(FALSE) names(mod_xfw$coefficients)
#
# #F-Statistic
if(FALSE) summary(mod_xfw)$fstatistic
#
# #Adjusted Rsq
if(TRUE) summary(mod_xfw)$adj.r.squared
#
# #confint() for Confidence Interval
if(FALSE) confint(mod_xfw)
#
# #Save Results
res_xfw <- xfw 
#
# #Augment the Tibble with Fitted and Residuals
res_xfw <- augment(mod_xfw)
#
ii <- unname(predict(mod_xfw))
jj <- round(unname(residuals(mod_xfw)), 3)
kk <- unname(rstandard(mod_xfw))
#
stopifnot(identical(res_xfw$.fitted, ii))
stopifnot(identical(round(res_xfw$.resid, 3), jj))
stopifnot(identical(res_xfw$.std.resid, kk))
```

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-Residuals-Set', include=FALSE}
# #Setup for Residuals Plot of lm() 
hh <- res_xfw %>% 
  rename(Response = medv) %>% 
  select(-c(chas, rad, zn, .hat, .sigma, .cooksd, .std.resid)) %>% 
  pivot_longer(!c(Response, .fitted, .resid)) %>% 
  mutate(across(name, factor, levels = unique(name)))
#
cap_hh <- "F66P03"
ttl_hh <- "Boston: Residuals of Linear Regression of Y (medv)"
sub_hh <- "Except Categorical (maybe): chas, rad, zn (& dots)"
```

```{r 'F66-BS-Residuals-Plot', include=FALSE, ref.label=c('F66-Plot-Residuals')}
#
```

```{r 'F66P03-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P03", "-Boston-lm-Residuals", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P03, device = "png", dpi = 144, width = k_width, height = k_height) 
}
```

```{r 'F66P03', echo=FALSE, fig.cap="(F66P03) Boston: Residuals of Linear Regression of Y (medv)"}
knitr::include_graphics(paste0(.z$PX, "F66P03", "-Boston-lm-Residuals", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-Residuals-Set-A', eval=FALSE, ref.label=c('F66-BS-Residuals-Set')}
#
```

```{r 'F66-Plot-Residuals', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (long)
F66 <- hh %>% { ggplot(data = ., mapping = aes(x = value, y = Response)) +
    geom_smooth(formula = 'y ~ x', method = "lm", se = FALSE, color = "#440154FF") +
    geom_segment(aes(xend = value, yend = .fitted), alpha = 0.2) +
    geom_point(aes(color = abs(.resid)), size = 1) + 
    #geom_point(aes(y = .fitted), shape = 1, size = 1) + 
    facet_wrap(~ name, scales = "free_x") +
    scale_colour_distiller(palette = "BrBG") + 
    scale_y_continuous(breaks = breaks_pretty()) + 
    scale_x_continuous(breaks = breaks_pretty()) + 
    theme(panel.grid = element_blank()) +
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
eval(parse(text = cap_hh))
```

### Residual vs. Fitted {.tabset .tabset-fade}

```{conjecture 'brrom-dataframe'}
\textcolor{brown}{Error: `data_frame()` was deprecated in tibble 1.1.0. Please use `tibble()` instead.}
```

- \textcolor{orange}{Warning:} "Data frame tidiers are deprecated and will be removed in an upcoming release of broom."
- The Error & Warning occur if model resul is passed to tidy() in place of actual model



#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-ResidFit-Set', include=FALSE}
# #Setup for Residual vs. Fitted Plot of lm()
hh <- res_xfw
#
cap_hh <- "F66P04"
ttl_hh <- "Boston: Residuals vs. Fitted for Linear Regression"
sub_hh <- NULL
```

```{r 'F66-BS-ResidFit-Plot', include=FALSE, ref.label=c('F66-Plot-ResidFit')}
#
```

```{r 'F66P04-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P04", "-Boston-lm-Resid-Fit", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P04, device = "png", dpi = 144) 
}
```

```{r 'F66P04', echo=FALSE, fig.cap="(F66P04) Boston: Residuals vs. Fitted for Linear Regression"}
knitr::include_graphics(paste0(.z$PX, "F66P04", "-Boston-lm-Resid-Fit", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-ResidFit-Set-A', eval=FALSE, ref.label=c('F66-BS-ResidFit-Set')}
#
```

```{r 'F66-Plot-Residuals', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (augmented)
F66 <- hh %>% { ggplot(data = ., mapping = aes(x = .fitted, y = .resid)) +
    geom_smooth(formula = 'y ~ x', method = "loess", se = FALSE, color = "#440154FF") +
    geom_point(aes(color = abs(.resid)), size = 1) + 
    geom_hline(yintercept = 0, linetype = 2) +
    scale_colour_distiller(palette = "BrBG") + 
    scale_y_continuous(breaks = breaks_pretty()) + 
    scale_x_continuous(breaks = breaks_pretty()) + 
    theme(panel.grid = element_blank()) +
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
#eval(parse(text = cap_hh))
```

### Normal QQ {.tabset .tabset-fade}

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-QQ-Set', include=FALSE}
# #Setup for QQ Plot of Results by lm()
hh <- res_xfw
#
cap_hh <- "F66P05"
ttl_hh <- "Boston: QQ for Linear Regression"
x_hh <- "Theoretical"
y_hh <- "Sample"
sub_hh <- NULL 
```

```{r 'F66-BS-QQ-Plot', include=FALSE, ref.label=c('F66-Plot-QQ')}
#
```

```{r 'F66P05-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P05", "-Boston-lm-QQ", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P05, device = "png", dpi = 144) 
}
```

```{r 'F66P05', echo=FALSE, fig.cap="(F66P05) Boston: QQ for Linear Regression"}
knitr::include_graphics(paste0(.z$PX, "F66P05", "-Boston-lm-QQ", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-QQ-Set-A', eval=FALSE, ref.label=c('F66-BS-QQ-Set')}
#
```

```{r 'F66-Plot-QQ', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (augmented) 
F66 <- hh %>% { ggplot(data = ., mapping = aes(sample = .std.resid)) +
    geom_qq(size = 1) + 
    geom_qq_line(color = "#440154FF") + 
    labs(x = x_hh, y = y_hh, subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
#eval(parse(text = cap_hh))
```


### Scale vs. Location {.tabset .tabset-fade}

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-ScaleLoc-Set', include=FALSE}
# #Setup for Scale vs. Location Plot of Results by lm()
hh <- res_xfw
#
cap_hh <- "F66P06"
ttl_hh <- "Boston: lm() Scale vs. Location"
sub_hh <- NULL 
```

```{r 'F66-BS-ScaleLoc-Plot', include=FALSE, ref.label=c('F66-Plot-ScaleLoc')}
#
```

```{r 'F66P06-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P06", "-Boston-lm-Scale-Loc", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P06, device = "png", dpi = 144) 
}
```

```{r 'F66P06', echo=FALSE, fig.cap="(F66P06) Boston: lm() Scale vs. Location"}
knitr::include_graphics(paste0(.z$PX, "F66P06", "-Boston-lm-Scale-Loc", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-ScaleLoc-Set-A', eval=FALSE, ref.label=c('F66-BS-ScaleLoc-Set')}
#
```

```{r 'F66-Plot-ScaleLoc', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (augmented) 
F66 <- hh %>% { ggplot(data = ., mapping = aes(x = .fitted, y = sqrt(abs(.std.resid)))) +
    geom_point(aes(color = .std.resid), size = 1) + 
    geom_smooth(formula = 'y ~ x', method = "loess", se = FALSE, color = "#440154FF") +
    scale_colour_distiller(palette = "BrBG") + 
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
#eval(parse(text = cap_hh))
```


### Residuals vs. Leverage {.tabset .tabset-fade}

#### Plot {.unlisted .unnumbered}

```{r 'F66-BS-Leverage-Set', include=FALSE}
# #Setup for Residuals vs. Leverage Plot of Results by lm()
hh <- res_xfw
#
cap_hh <- "F66P07"
ttl_hh <- "Boston: lm() Residuals vs. Leverage"
sub_hh <- NULL
```

```{r 'F66-BS-Leverage-Plot', include=FALSE, ref.label=c('F66-Plot-Leverage')}
#
```

```{r 'F66P07-Save', include=FALSE}
loc_png <- paste0(.z$PX, "F66P07", "-Boston-lm-Leverage", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = F66P07, device = "png", dpi = 144) 
}
```

```{r 'F66P07', echo=FALSE, fig.cap="(F66P07) Boston: lm() Residuals vs. Leverage"}
knitr::include_graphics(paste0(.z$PX, "F66P07", "-Boston-lm-Leverage", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'F66-BS-Leverage-Set-A', eval=FALSE, ref.label=c('F66-BS-Leverage-Set')}
#
```

```{r 'F66-Plot-Leverage', eval=FALSE}
# #IN: sub_hh, cap_hh, ttl_hh, hh (augmented) 
F66 <- hh %>% { ggplot(data = ., mapping = aes(x = .cooksd, y = .std.resid)) +
    geom_point(size = 1) + 
    geom_smooth(formula = 'y ~ x', method = "loess", se = FALSE, color = "#440154FF") +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, F66)
rm(F66)
#eval(parse(text = cap_hh))
```

### Basic 4 Plots (GGPlot)

```{r 'F66P0407', echo=FALSE, ref.label=c('F66P04', 'F66P05', 'F66P06', 'F66P07'), fig.cap="(F66P04, F66P05, F66P06, F66P07) Boston: Basic 4 Graphs by GGPlot"}
#
```



## xx

```{r 'F66-'}
#plot(xfw$lstat, xfw$medv); abline(mod_xfw)
#ggplot(mod_xfw, aes(x = .fitted, y = .resid)) + geom_point()


```

## Validation {.unlisted .unnumbered .tabset .tabset-fade}

```{r 'F66-Cleanup', include=FALSE, cache=FALSE}
f_rmExist(aa, bb, ii, jj, kk, ll)
```

```{r 'F66-Validation', include=TRUE, cache=FALSE}
# #SUMMARISED Packages and Objects (BOOK CHECK)
f_()
#
difftime(Sys.time(), k_start)
```

****

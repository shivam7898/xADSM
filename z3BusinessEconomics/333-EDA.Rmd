# EDA {#c33}

```{r 'C33', include=FALSE, cache=FALSE}
sys.source(paste0(.z$RX, "A99Knitr", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "000Packages", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "A00AllUDF", ".R"), envir = knitr::knit_global())
#invisible(lapply(f_getPathR(A09isPrime), knitr::read_chunk))
```

## Overview

- "Exploratory Data Analysis"
  - Refer [L: Data Pre-Processing](#b16 "b16"), [L: Data Pre-Processing](#b17 "b17"), [L: Unsupervised Learning](#b18 "b18"), and [Numerical Measures](#c03 "c03")

## Churn

\textcolor{pink}{Please import the "B18-Churn.xlsx".}

```{r 'C32-ImportData', include=FALSE}
xxB16Cars <- f_getRDS(xxB16Cars)
xxB18Churn <- f_getRDS(xxB18Churn)
#
c33churn <- xxB18Churn %>% rename_with(make.names) %>% 
  rename_with(~ tolower(gsub(".", "_", .x, fixed = TRUE))) %>% 
  mutate(across(c(int_l_plan, vmail_plan), ~case_when(. == "yes" ~ TRUE, . == "no" ~ FALSE))) %>% 
  mutate(across(churn, ~case_when(. == "True." ~ TRUE, . == "False." ~ FALSE))) %>% 
  mutate(across(ends_with("_calls"), as.integer))
```

- Churn (attrition)
  - It is a term used to indicate a customer leaving the service of one company in favor of another company. 
  - The data set contains 20 predictors worth of information about 3333 customers, along with the target variable, churn, an indication of whether that customer churned (left the company) or not.
- Description [3333, 21]
  - State: Categorical, for the 50 states and the District of Columbia. 
  - Account length: Integer-valued, how long account has been active. 
  - Area code: Categorical 
  - Phone number: Essentially a surrogate for customer ID. 
  - International plan: Dichotomous categorical, yes or no. 
  - Voice mail plan: Dichotomous categorical, yes or no. 
  - Number of voice mail messages: Integer-valued. 
  - Total day minutes: Continuous, minutes customer used service during the day. 
  - Total day calls: Integer-valued. 
  - Total day charge: Continuous, perhaps based on above two variables. 
  - Total eve minutes: Continuous, minutes customer used service during the evening. 
  - Total eve calls: Integer-valued. 
  - Total eve charge: Continuous, perhaps based on above two variables. 
  - Total night minutes: Continuous, minutes customer used service during the night. 
  - Total night calls: Integer-valued. 
  - Total night charge: Continuous, perhaps based on above two variables. 
  - Total international minutes: Continuous, minutes customer used service to make international calls. 
  - Total international calls: Integer-valued. 
  - Total international charge: Continuous, perhaps based on above two variables. 
  - Number of calls to customer service: Integer-valued. 
  - Churn: Target. Indicator of whether the customer has left the company (True or False)

## Basics, Skewness & Normality

```{r 'C33-Normality', include=FALSE}
bb <- aa <- c33churn
#str(bb)
ii <- bb %>% select(2, 7:20) %>% 
  relocate(vmail_message, .after = last_col()) %>% 
  relocate(account_length, .after = last_col()) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, factor, levels = unique(Key)))
#
#str(ii)
#levels(ii$Key)
#
jj <- ii %>% group_by(Key) %>% 
  summarise(Min = min(Values), Max = max(Values), SD = sd(Values), 
            Mean = mean(Values), Median = median(Values), Mode = f_getMode(Values),
            Unique = length(unique(Values)), isNA = sum(is.na(Values)), 
            Skewness = skewness(Values), 
            p_Shapiro = shapiro.test(Values)$p.value, 
            isNormal = ifelse(p_Shapiro > 0.05, TRUE, FALSE)) %>% 
  mutate(across(where(is.numeric), round, digits = 4)) %>% 
  mutate(across(where(is.numeric), format, digits = 3, nsmall = 0, 
                replace.zero = TRUE, zero.print = "0", scientific = FALSE, drop0trailing = TRUE)) 
```

```{r 'C33T01', echo=FALSE}
kbl(jj,
  caption = "(C33T01) Churn: Normality",
  #col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) %>% 
# #Conditional Row Text Highlight. Background etc. can also be done.
  row_spec(which(!jj$isNormal), color = "red") # %>% row_spec(which(jj$isNormal), color = "black")
```

## Explore Categorical Variables

### International Plan

```{r 'C-Intl', include=FALSE}
ii <- bb %>% select(int_l_plan, churn) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(int_l_plan, churn) 
#
jj <- ii %>% rename("isIntl_isChurn" = 1, y = 2) %>% 
  pivot_wider(names_from = y, values_from = n, values_fill = 0, names_sort = TRUE) %>%
  #mutate(across(1, as.character)) %>% 
  add_row(summarise(., across(1, ~ "Total")), summarise(., across(where(is.numeric), sum))) %>% 
  mutate(SUM = rowSums(across(where(is.numeric)))) %>% 
  mutate(across(2:3, list(r = ~ round(. /SUM, 3)), .names = "{.fn}{.col}")) %>% 
  mutate(across(2:3, list(rp = ~ paste0(round(100 * . /SUM, 1), "%")), 
                .names = "{.fn}{.col}")) %>%
  mutate(across(2:4, list(c = ~ 2 * ./sum(.)), .names = "{.fn}{.col}")) %>% 
  mutate(across(2:4, list(cp = ~ paste0(round(100 * 2 * . /sum(.), 1), "%")), 
                .names = "{.fn}{.col}"))
#
kk <- ii %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
```

#### Contingency Table (CrossTab) {.unlisted .unnumbered}

- 28.4% of churners belong to the International Plan, compared to 6.5% of non-churners.
- 42.4% of the International Plan holders churned, as compared to only 11.5% of those without the International Plan.
- The proportion of International Plan holders is greater among the churners.
- Summary
  - We should investigate what is it about our international plan that is inducing our customers to leave
  - We should expect that, the model (in future) will probably include whether or not the customer selected the International Plan.

```{r 'C33T02', echo=FALSE}
kk <- jj %>% select(-c(5:6, 9:11)) 
#names(kk) <- paste0(names(kk), "<br/> <br/>")
displ_names <-c(paste0("Churn ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " International"), 
                "Row <br/> No", "Row <br/> Yes", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(kk), length(displ_names)))
#
kbl(kk,
  caption = "(C33T02) International Plan vs. Churn",
  col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) %>% row_spec(row = 1:nrow(kk), color = "black")
```

#### Bar Charts {.unlisted .unnumbered}

- Bar Charts
  - Grouped 
    - These are good for comparing between each element in the categories, and comparing elements across categories.
  - Stacked 
    - They are great for showing the total because they visually aggregate all of the categories in a group. 
    - The downside is that it becomes harder to compare the sizes of the individual categories. 
    - Stacking also indicates a part to whole relationship.
  - Stacked Percent
    - The total quantity is hidden by using percentages, but it iss easier to see the relative difference between quantities in each group.
  - Summary
    - If there is no part to whole relationship (maybe there is overlap in the categories), then grouped
    - If there is a part to whole relationship, then the next question to ask is what relationship is the most important to show. 
      - If the goal is to show sizes between individual categories, use a grouped column or bar chart. 
      - If the goal is to show the total sizes of groups, use a regular stacked bar chart. 
      - If the goal is to show relative differences within each group, use a stacked percentage column chart.

```{conjecture 'stat-count-xy'}
\textcolor{brown}{Error: stat_count() can only have an x or y aesthetic.}
```

```{conjecture 'stat-count-y'}
\textcolor{brown}{Error: stat_count() must not be used with a y aesthetic.}
```

- \textcolor{pink}{stat_count()} Based on the data, choose stat 
  - stat = 'identity' tells ggplot2 that you will provide the y-values (i.e. Wide Data)
  - stat = 'count' is the default, which implies that ggplot2 will count the aggregate number of rows for each x value. (i.e. Long Data)

```{r 'C-BarGroupIplan', include=FALSE}
# #Grouped Bar Chart
#str(kk)
hh <- kk
#
caption_hh <- "C33P01"
title_hh <- "Churn: Grouped Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Frequency"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5, 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.5, .95), 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P01-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P01","_Churn_Bar_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P01)
```

```{r 'C33P01', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P01","_Churn_Bar_Intl", ".png"))
```

```{r 'C-BarStackIplan', include=FALSE}
# #Stacked Bar Chart
#str(kk)
hh <- kk
#
caption_hh <- "C33P02"
title_hh <- "Churn: Stacked Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Frequency"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "stack", stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.9, .9)) +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P02-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P02","_Churn_Stack_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P02)
```

```{r 'C33P02', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P02","_Churn_Stack_Intl", ".png"))
```


```{r 'C-BarPStackIplan', include=FALSE}
# #Percent Stacked Bar Chart
#str(kk)
hh <- kk
#
caption_hh <- "C33P03"
title_hh <- "Churn: Percent Stacked Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Grouped Percentage"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "fill", stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    scale_y_continuous(labels = percent_format()) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P03-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P03","_Churn_pStack_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P03)
```

```{r 'C33P03', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P03","_Churn_pStack_Intl", ".png"))
```


```{r 'C33P010203', echo=FALSE, ref.label=c('C33P01', 'C33P02', 'C33P03'), fig.cap="International Plan holders tend to churn more frequently", out.width='33%'}
#
```

### Voice Mail Plan

```{r 'C-Voice', include=FALSE}
ii <- bb %>% select(int_l_plan, churn) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(int_l_plan, churn) 
#
jj <- ii %>% rename("isIntl_isChurn" = 1, y = 2) %>% 
  pivot_wider(names_from = y, values_from = n, values_fill = 0, names_sort = TRUE) %>%
  #mutate(across(1, as.character)) %>% 
  add_row(summarise(., across(1, ~ "Total")), summarise(., across(where(is.numeric), sum))) %>% 
  mutate(SUM = rowSums(across(where(is.numeric)))) %>% 
  mutate(across(2:3, list(r = ~ round(. /SUM, 3)), .names = "{.fn}{.col}")) %>% 
  mutate(across(2:3, list(rp = ~ paste0(round(100 * . /SUM, 1), "%")), 
                .names = "{.fn}{.col}")) %>%
  mutate(across(2:4, list(c = ~ 2 * ./sum(.)), .names = "{.fn}{.col}")) %>% 
  mutate(across(2:4, list(cp = ~ paste0(round(100 * 2 * . /sum(.), 1), "%")), 
                .names = "{.fn}{.col}"))
#
kk <- ii %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
```

## Validation {.unlisted .unnumbered .tabset .tabset-fade}

```{r 'C33-Cleanup', include=FALSE, cache=FALSE}
f_rmExist(aa, bb, ii, jj, kk, ll, c33churn, C33P01, C33P02, C33P03, caption_hh, hh, legend_hh, loc_png, subt_hh, title_hh, x_hh, xxB16Cars, xxB18Churn, y_hh)
```

```{r 'C33-Validation', include=TRUE, cache=FALSE}
# #SUMMARISED Packages and Objects (BOOK CHECK)
f_()
#
difftime(Sys.time(), k_start)
```

****

# EDA {#c33}

```{r 'C33', include=FALSE, cache=FALSE}
sys.source(paste0(.z$RX, "A99Knitr", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "000Packages", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "A00AllUDF", ".R"), envir = knitr::knit_global())
#invisible(lapply(f_getPathR(A09isPrime), knitr::read_chunk))
```

## Overview

- "Exploratory Data Analysis"
  - Refer [L: Data Pre-Processing](#b16 "b16"), [L: Data Pre-Processing](#b17 "b17"), [L: Unsupervised Learning](#b18 "b18"), and [Numerical Measures](#c03 "c03")

## Churn

\textcolor{pink}{Please import the "B18-Churn.xlsx".}

```{r 'C32-ImportData', include=FALSE}
xxB16Cars <- f_getRDS(xxB16Cars)
xxB18Churn <- f_getRDS(xxB18Churn)
#
c33churn <- xxB18Churn %>% rename_with(make.names) %>% 
  rename_with(~ tolower(gsub(".", "_", .x, fixed = TRUE))) %>% 
  mutate(across(c(int_l_plan, vmail_plan), ~case_when(. == "yes" ~ TRUE, . == "no" ~ FALSE))) %>% 
  mutate(across(churn, ~case_when(. == "True." ~ TRUE, . == "False." ~ FALSE))) %>% 
  mutate(across(ends_with("_calls"), as.integer))
```

- Churn (attrition)
  - It is a term used to indicate a customer leaving the service of one company in favor of another company. 
  - The data set contains 20 predictors worth of information about 3333 customers, along with the target variable, churn, an indication of whether that customer churned (left the company) or not.
- Description [3333, 21]
  - State: Categorical, for the 50 states and the District of Columbia. 
  - Account length: Integer-valued, how long account has been active. 
  - Area code: Categorical 
  - Phone number: Essentially a surrogate for customer ID. 
  - International plan: Dichotomous categorical, yes or no. 
  - Voice mail plan: Dichotomous categorical, yes or no. 
  - Number of voice mail messages: Integer-valued. 
  - Total day minutes: Continuous, minutes customer used service during the day. 
  - Total day calls: Integer-valued. 
  - Total day charge: Continuous, perhaps based on above two variables. 
  - Total eve minutes: Continuous, minutes customer used service during the evening. 
  - Total eve calls: Integer-valued. 
  - Total eve charge: Continuous, perhaps based on above two variables. 
  - Total night minutes: Continuous, minutes customer used service during the night. 
  - Total night calls: Integer-valued. 
  - Total night charge: Continuous, perhaps based on above two variables. 
  - Total international minutes: Continuous, minutes customer used service to make international calls. 
  - Total international calls: Integer-valued. 
  - Total international charge: Continuous, perhaps based on above two variables. 
  - Number of calls to customer service: Integer-valued. 
  - Churn: Target. Indicator of whether the customer has left the company (True or False)

## Basics, Skewness & Normality

```{r 'C33-Normality', include=FALSE}
bb <- aa <- c33churn
#str(bb)
ii <- bb %>% select(2, 7:20) %>% 
  relocate(vmail_message, .after = last_col()) %>% 
  relocate(account_length, .after = last_col()) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, factor, levels = unique(Key)))
#
#str(ii)
#levels(ii$Key)
#
jj <- ii %>% group_by(Key) %>% 
  summarise(Min = min(Values), Max = max(Values), SD = sd(Values), 
            Mean = mean(Values), Median = median(Values), Mode = f_getMode(Values),
            Unique = length(unique(Values)), isNA = sum(is.na(Values)), 
            Skewness = skewness(Values), 
            p_Shapiro = shapiro.test(Values)$p.value, 
            isNormal = ifelse(p_Shapiro > 0.05, TRUE, FALSE))
#
kk <- jj %>% 
  mutate(across(where(is.numeric), round, digits = 4)) %>% 
  mutate(across(where(is.numeric), format, digits = 3, nsmall = 0, 
                replace.zero = TRUE, zero.print = "0", scientific = FALSE, drop0trailing = TRUE)) 
```

```{r 'C33T01', echo=FALSE}
kbl(kk,
  caption = "(C33T01) Churn: Normality",
  #col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) %>% 
# #Conditional Row Text Highlight. Background etc. can also be done.
  row_spec(which(!kk$isNormal), color = "red") # %>% row_spec(which(kk$isNormal), color = "black")
```

## Explore Categorical Variables

### International Plan

```{r 'C33-SetIntl', include=FALSE}
# #xyw: x (independent), y (dependent), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer), 
r_xyg <- "International"
c_xyg <- "Churn"
xyg <- bb %>% select(int_l_plan, churn) %>% rename(x = 1, y = 2) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(x, y) 
#
str(xyg)
```

```{r 'C33-CrossIntl', echo=FALSE, ref.label=c('C33-CrossTab')}
#
```

#### Contingency Table (CrossTab) {.unlisted .unnumbered}

- 28.4% of churners belong to the International Plan, compared to 6.5% of non-churners.
- 42.4% of the International Plan holders churned, as compared to only 11.5% of those without the International Plan.
- The proportion of International Plan holders is greater among the churners.
- Summary
  - We should investigate what is it about our international plan that is inducing our customers to leave
  - We should expect that, the model (in future) will probably include whether or not the customer selected the International Plan.

```{r 'C33-SetCrossIntl', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T02) ", r_xyg, " vs. ", c_xyg)
```


```{r 'C33T02', echo=FALSE, ref.label=c('C33-CrossKbl')}
#
```

#### Bar Charts {.unlisted .unnumbered .tabset .tabset-fade}

- Bar Charts
  - Grouped 
    - These are good for comparing between each element in the categories, and comparing elements across categories.
  - Stacked 
    - They are great for showing the total because they visually aggregate all of the categories in a group. 
    - The downside is that it becomes harder to compare the sizes of the individual categories. 
    - Stacking also indicates a part to whole relationship.
  - Stacked Percent
    - The total quantity is hidden by using percentages, but it iss easier to see the relative difference between quantities in each group.
  - Summary
    - If there is no part to whole relationship (maybe there is overlap in the categories), then grouped
    - If there is a part to whole relationship, then the next question to ask is what relationship is the most important to show. 
      - If the goal is to show sizes between individual categories, use a grouped column or bar chart. 
      - If the goal is to show the total sizes of groups, use a regular stacked bar chart. 
      - If the goal is to show relative differences within each group, use a stacked percentage column chart.

```{conjecture 'stat-count-xy'}
\textcolor{brown}{Error: stat_count() can only have an x or y aesthetic.}
```

```{conjecture 'stat-count-y'}
\textcolor{brown}{Error: stat_count() must not be used with a y aesthetic.}
```

- \textcolor{pink}{stat_count()} Based on the data, choose stat 
  - stat = 'identity' tells ggplot2 that you will provide the y-values (i.e. Wide Data)
  - stat = 'count' is the default, which implies that ggplot2 will count the aggregate number of rows for each x value. (i.e. Long Data)

```{r 'C33-BarGroupIplan', include=FALSE}
# #Grouped Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
caption_hh <- "C33P01"
title_hh <- "Churn: Grouped Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan" #r_xyg
y_hh <- "Frequency"
legend_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5, 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.5, .95), 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P01-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P01","_Churn_Bar_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P01)
```

```{r 'C33P01', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P01","_Churn_Bar_Intl", ".png"))
```

```{r 'C33-BarStackIplan', include=FALSE}
# #Stacked Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
caption_hh <- "C33P02"
title_hh <- "Churn: Stacked Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Frequency"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "stack", stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.9, .9)) +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P02-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P02","_Churn_Stack_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P02)
```

```{r 'C33P02', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P02","_Churn_Stack_Intl", ".png"))
```


```{r 'C33-BarPStackIplan', include=FALSE}
# #Percent Stacked Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
caption_hh <- "C33P03"
title_hh <- "Churn: Percent Stacked Bar: International Plan vs. Churn"
subt_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Grouped Percentage"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "fill", stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    scale_y_continuous(labels = percent) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P03-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P03","_Churn_pStack_Intl", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P03)
```

```{r 'C33P03', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P03","_Churn_pStack_Intl", ".png"))
```

##### Image {.unlisted .unnumbered}

```{r 'C33P010203', echo=FALSE, ref.label=c('C33P01', 'C33P02', 'C33P03'), fig.cap="International Plan holders tend to churn more frequently", out.width='33%'}
#
```

##### Code CrossTab {.unlisted .unnumbered}

```{r 'C33-SetIntl-A', eval=FALSE, ref.label=c('C33-SetIntl')}
#
```


```{r 'C33-CrossTab', eval=FALSE}
# #IN: xyg, r_xyg, c_xyg
# #Generate Contingency Table (CrossTab)
ctab <- xyg %>% 
  pivot_wider(names_from = y, values_from = n, values_fill = 0, names_sort = TRUE) %>%
  #mutate(across(1, as.character)) %>% 
  add_row(summarise(., across(1, ~ "Total")), summarise(., across(where(is.numeric), sum))) %>% 
  mutate(SUM = rowSums(across(where(is.numeric)))) %>% 
  mutate(across(where(is.numeric) & !matches("SUM"), 
                list(r = ~ round(. /SUM, 3)), .names = "xx_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !matches("SUM"), 
                list(rp = ~ paste0(round(100 * . /SUM, 1), "%")), .names = "{.fn}{.col}")) %>%
  mutate(across(where(is.numeric) & !starts_with("xx_"), 
                list(c = ~ 2 * ./sum(.)), .names = "yy_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !starts_with("yy_"), 
                list(cp = ~ paste0(round(100 * 2 * . /sum(.), 1), "%")), .names = "{.fn}{.col}"))
```

##### Code CrossTab Print {.unlisted .unnumbered}


```{r 'C33-SetCrossIntl-A', eval=FALSE, ref.label=c('C33-SetCrossIntl')}
#
```


```{r 'C33-CrossKbl', eval=FALSE}
#
kbl(hh,
  caption = cap_hh,
  col.names = names_hh,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) #%>% row_spec(row = 1:nrow(hh), color = "black")
```

### Voice Mail Plan

```{r 'C33-SetVmail', include=FALSE}
# #xyw: x (independent), y (dependent), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer), 
r_xyg <- "VoiceMail"
c_xyg <- "Churn"
xyg <- bb %>% select(vmail_plan, churn) %>% rename(x = 1, y = 2) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(x, y) 
#
str(xyg)
```

```{r 'C33-CrossVmail', echo=FALSE, ref.label=c('C33-CrossTab')}
#
```


#### Contingency Table (CrossTab) {.unlisted .unnumbered}

- 16.7% of those without the Voice Mail Plan are churners, as compared to 8.7% of customers who do have the Voice Mail Plan. 
  - Thus, customers without the Voice Mail Plan are nearly twice as likely to churn as customers with the plan.
- Summary
  - Perhaps we should enhance our Voice Mail Plan still further, or make it easier for customers to join it, as an instrument for increasing customer loyalty
  - We should expect that, the model (in future) will probably include whether or not the customer selected the Voice Mail Plan. Our confidence in this expectation is perhaps not quite as high as for the International Plan

```{r 'C33-SetCrossVmail', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T03) ", r_xyg, " vs. ", c_xyg)
```


```{r 'C33T03', echo=FALSE, ref.label=c('C33-CrossKbl')}
#
```

### Three Categorical Variables {.tabset .tabset-fade}

- Two-way interactions among categorical variables with respect to churn. 
  - Multilayer clustered bar chart of churn, clustered by both International Plan and Voice Mail Plan. 
    - There are many more customers who have neither plan. 
    - There are many more customers who have the voice mail plan only than have both plans. 
    - More importantly, among customers with no voice mail plan, the proportion of churners is greater for those who do have an international plan (43.7%) than for those who do not (13.9%).
    - Again, however, among customers with the voice mail plan, the proportion of churners is much greater for those who also select the international plan (39.1%) than for those who do not (5.3%).
    - Note also that there is no interaction among the categorical variables. That is, international plan holders have greater churn regardless of whether they are Voice Mail plan adopters or not.

```{r 'C33-ThreeCat', include=FALSE}
xsyg <- bb %>% select(int_l_plan, vmail_plan, churn) %>% 
  rename(Intl = 1, Vmail =2, Churn = 3) %>% 
  mutate(across(Churn, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Intl, ~ifelse(., "I: Yes", "I: No"))) %>% 
  mutate(across(Vmail, ~ifelse(., "V: Yes", "V: No"))) %>% 
  count(Intl, Vmail, Churn) %>% rename(N = n)
```

```{r 'C33-BarMultiCatMultiFacet', include=FALSE}
# #Multilayer Clustered Bar Chart
hh <- xsyg
#
caption_hh <- "C33P04"
title_hh <- "Churn: Churn vs. International & Voice Mail Plans"
subt_hh <- NULL 
x_hh <- "Churn" #r_xyg
y_hh <- "Frequency"
legend_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Churn, y = N, fill = Churn)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N)) +
    facet_wrap(Intl ~ Vmail, nrow = 1) +
    scale_fill_manual(values = c('#FFEA46FF', '#787877FF')) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = 'top', 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P04-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P04","_Churn_MultiClusterBar", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P04)
```

```{r 'C33P04', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P04","_Churn_MultiClusterBar", ".png"))
```


```{r 'C33-BarMultiCatSingleFacet', include=FALSE}
# #Multilayer Clustered Bar Chart
hh <- xsyg
#
caption_hh <- "C33P05"
title_hh <- "Churn: Churn vs. International & Voice Mail Plans"
subt_hh <- NULL 
x_hh <- NULL #"Churn" #r_xyg
y_hh <- "Frequency"
legend_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Vmail, y = N, fill = Churn)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5) +
    facet_wrap(~Intl, nrow = 1) +
    scale_fill_manual(values = c('#FFEA46FF', '#787877FF')) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = 'top', 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = NULL, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P05-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P05","_Churn_MultiClusterBarSingleFacet", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P05)
```

```{r 'C33P05', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P05","_Churn_MultiClusterBarSingleFacet", ".png"))
```

#### Image {.unlisted .unnumbered}

```{r 'C33P0405', echo=FALSE, ref.label=c('C33P04', 'C33P05'), fig.cap="Churn vs. International & Voice Mail Plans (Both are Same Graphs)"}
#
```


```{r 'C33-BarPStackIplanMulti', include=FALSE}
# #Percent Stacked Bar Chart
hh <- xsyg %>% group_by(Vmail, Intl) %>% 
    mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
caption_hh <- "C33P06"
title_hh <- "Churn: Churn vs. International & Voice Mail Plans"
subt_hh <- NULL 
x_hh <- "Voice Mail"
y_hh <- "Grouped Percentage"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Vmail, y = N, fill = Churn)) + 
        geom_bar(position = "fill", stat = 'identity') + 
        facet_wrap(~Intl, nrow = 1) +
        geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = rep(c("black", "white"), 4)) +
        scale_fill_viridis_d(direction = -1) +	
        scale_y_continuous(labels = percent) +
        theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
        labs(x = x_hh, y = y_hh, fill = legend_hh, 
            subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P06-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P06","_Churn_pStack_Multi", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P06)
```

```{r 'C33P06', echo=FALSE, fig.cap="Churn vs. International & Voice Mail Plans (Proportional Stack)"}
knitr::include_graphics(paste0(.z$PX, "C33P06","_Churn_pStack_Multi", ".png"))
```


#### Code {.unlisted .unnumbered}

```{r 'C33-ThreeCat-A', eval=FALSE, ref.label=c('C33-ThreeCat')}
#
```

```{r 'C33-BarMultiCatMultiFacet-A', eval=FALSE, ref.label=c('C33-BarMultiCatMultiFacet')}
#
```

```{r 'C33-BarMultiCatSingleFacet-A', eval=FALSE, ref.label=c('C33-BarMultiCatSingleFacet')}
#
```

#### Code More {.unlisted .unnumbered}

```{r 'C33-BarPStackIplanMulti-A', eval=FALSE, ref.label=c('C33-BarPStackIplanMulti')}
#
```

## Exploring Numeric Variables

- Refer figure \@ref(fig:C33P07) & Table \@ref(tab:C33T01)
  - Fields not showing evidence of symmetry include voice mail messages and customer service calls.
  - Voice Mail Messages: Median = 0 
    - Indicating that at least half of all customers had no voice mail messages. 
    - Because fewer than half of the customers select the Voice Mail Plan (27.7%). 
  - Customer Service Calls: Mean = 1.56 > Median = 1
    - It indicates some right-skewness
    - Also indicated by the maximum number of customer service calls (9).

```{r 'C33P07', echo=FALSE, ref.label=c('B18P03'), fig.cap="Churn: All Histograms"}
# #Ref another file chunk
```


### Overlay Histogram {.tabset .tabset-fade}

- To explore whether a predictor is useful for predicting the target variable
  - Bars are colored according to the values of the target variable. 
  
```{r 'C33-ServCall', include=FALSE}
ii <- bb %>% select(custserv_calls, churn) %>% 
  rename(Churn = 2) %>% 
  mutate(across(Churn, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistServCall', include=FALSE}
# #Histogram Default (Not useful for association of predictor and target)
hh <- ii
title_hh <- "Churn: Customer Service Calls"
caption_hh <- "C33P08"
subt_hh <- "Predictor Only" 
x_hh <- "x"
y_hh <- "Frequency"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = '#FDE725FF')) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1) + 
    #stat_bin(bins = length(unique(.[[1]])), aes(y=..count.., label=..count..), 
    #         geom="text", position=position_stack(vjust=0.5)) +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          #legend.position = c(0.5, -0.08), legend.direction = 'horizontal', 
          legend.position = 'none') +
    labs(x = x_hh, y = y_hh, #fill = legend_hh,
         caption = caption_hh, subtitle = subt_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P08-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P08","_Churn_Hist_ServCall", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P08)
```

```{r 'C33P08', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P08","_Churn_Hist_ServCall", ".png"))
```

```{r 'C33-HistServCallChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
title_hh <- "Churn: Customer Service Calls & Churn"
caption_hh <- "C33P09"
subt_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = Churn)) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1) + 
    #stat_bin(bins = length(unique(.[[1]])), aes(y=..count.., label=..count..), 
    #         geom="text", position=position_stack(vjust=0.5)) +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = legend_hh,
         caption = caption_hh, subtitle = subt_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P09-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P09","_Churn_Hist_ServCall_Churn", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P09)
```

```{r 'C33P09', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P09","_Churn_Hist_ServCall_Churn", ".png")) 
```


```{r 'C33-pHistServCallChurn', include=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
title_hh <- "Churn: Customer Service Calls & Churn"
caption_hh <- "C33P10"
subt_hh <- "Proportion of Predictor & Target (Using Histogram)" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
legend_hh  <- "Churn"
#
# #NOTES: Group wise Proportion i.e. Yes 1, No 1 (Not Each Bin wise)
# #Adding Density automatically converts the y-axis to 'frequency density' not to 'percentage'
# #Both will match when Bin Width =1 but otherwise there will be a mismatch
# #Using y=..density.. scales the histograms so the area under each is 1, or sum(binwidth*y)=1. 
# #So use y = binwidth *..density.. to have y represent the fraction of the total in each bin. 
# #OR aes(y = stat(width*density))
# #OR aes(y = stat(count / sum(count)))
# #Clarification
# # ..count../sum(..count..) each count is divided by the total count
# # ..density.. it is applied to each group independently
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = Churn)) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1, position = 'fill') + 
    #stat_bin(bins = length(unique(.[[1]])), 
    #         aes(y = c(..count..[..group..==1]/sum(..count..[..group..==1]),
    #                   ..count..[..group..==2]/sum(..count..[..group..==2])), 
    #             label=round(..density.., 2)), geom="text") +
    #stat_bin(bins = length(unique(.[[1]])), 
    #         aes(y=..density.., group = ..group.., 
    #             label=round(..density.., 2)), geom="text") +
    scale_x_continuous(breaks = breaks_pretty()) + 
		#Deprecated : percent_format()
		scale_y_continuous(labels = percent) +
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = legend_hh,
         caption = caption_hh, subtitle = subt_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P10-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P10","_Churn_pHist_ServCall_Churn", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P10)
```

```{r 'C33P10', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
knitr::include_graphics(paste0(.z$PX, "C33P10","_Churn_pHist_ServCall_Churn", ".png"))
```

#### Image {.unlisted .unnumbered}

```{r 'C33P080910', echo=FALSE, ref.label=c('C33P08', 'C33P09', 'C33P10'), fig.cap="Service Calls beyond 3 have signficant increase in Churn", out.width='33%'}
#
```


```{r 'C33-pBarServCallChurn', include=FALSE}
# #complete() can be used to add the missing combination but not using it for now
xyg  <- ii %>% count(custserv_calls, Churn) 
     #%>% complete(custserv_calls, Churn, fill = list(n = 0)) 
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
title_hh <- "Churn: Customer Service Calls & Churn"
caption_hh <- "C33P11"
subt_hh <- "Proportion of Predictor & Target (Using Bar)" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
legend_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "fill", stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), 
              aes(label = ifelse(SubGroup == 'No', "", Ratio)), 
              colour = c(rep(c("black", "white"), 9), "white")) +
    scale_fill_viridis_d(direction = -1) +
    scale_x_continuous(breaks = breaks_pretty()) +
    scale_y_continuous(labels = percent) +
    theme(plot.title.position = "panel", axis.title.x = element_blank(), 
          panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = legend_hh, 
         subtitle = subt_hh, caption = caption_hh, title = title_hh)
}
assign(caption_hh, C33)
rm(C33)
```

```{r 'C33P11-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P11","_Churn_pBar_ServCall_Churn", ".png")
if(!file.exists(loc_png)) ggsave(loc_png, plot = C33P11)
```

```{r 'C33P11', echo=FALSE, fig.cap="Churn vs. Service Call Proportions (Bar)"}
knitr::include_graphics(paste0(.z$PX, "C33P11","_Churn_pBar_ServCall_Churn", ".png"))  #iiii
```

#### Code {.unlisted .unnumbered}

```{r 'C33-ServCall-A', eval=FALSE, ref.label=c('C33-ServCall', 'C33-HistServCall', 'C33-HistServCallChurn', 'C33-pHistServCallChurn')}
#
```

#### Code More {.unlisted .unnumbered}

```{r 'C33-pBarServCallChurn-A', eval=FALSE, ref.label=c('C33-pBarServCallChurn')}
#
```

## Validation {.unlisted .unnumbered .tabset .tabset-fade}

```{r 'C33-Cleanup', include=FALSE, cache=FALSE}
f_rmExist(aa, bb, ii, jj, kk, ll, c33churn, C33P01, C33P02, C33P03, caption_hh, hh, legend_hh, 
          loc_png, subt_hh, title_hh, x_hh, xxB16Cars, xxB18Churn, y_hh, c_xyg, cap_hh, ctab, 
          names_hh, r_xyg, xyg, C33P04, C33P05, C33P06, C33P08, C33P09, C33P10, xsyg)
```

```{r 'C33-Validation', include=TRUE, cache=FALSE}
# #SUMMARISED Packages and Objects (BOOK CHECK)
f_()
#
difftime(Sys.time(), k_start)
```

****

# EDA {#c33}

```{r 'C33', include=FALSE, cache=FALSE}
sys.source(paste0(.z$RX, "A99Knitr", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "000Packages", ".R"), envir = knitr::knit_global())
sys.source(paste0(.z$RX, "A00AllUDF", ".R"), envir = knitr::knit_global())
#invisible(lapply(f_getPathR(A09isPrime), knitr::read_chunk))
```

## Overview

- "Exploratory Data Analysis"
  - Refer [L: Data Pre-Processing](#b16 "b16"), [L: Data Pre-Processing](#b17 "b17"), [L: Unsupervised Learning](#b18 "b18"), and [Numerical Measures](#c03 "c03")

```{definition 'Data-Exploration'}
\textcolor{pink}{Data exploration} is the art of looking at your data, rapidly generating hypotheses, quickly testing them, then repeating again and again. The goal of data exploration is to generate many promising leads that you can later explore in more depth.
```

## Churn

\textcolor{pink}{Please import the "B18-Churn.xlsx"}

```{r 'C33-ImportData', include=FALSE}
xxB16Cars <- f_getRDS(xxB16Cars)
xxB18Churn <- f_getRDS(xxB18Churn)
#
c33churn <- xxB18Churn %>% rename_with(make.names) %>% 
  rename_with(~ tolower(gsub(".", "_", .x, fixed = TRUE))) %>% 
  mutate(across(c(int_l_plan, vmail_plan), ~case_when(. == "yes" ~ TRUE, . == "no" ~ FALSE))) %>% 
  mutate(across(churn, ~case_when(. == "True." ~ TRUE, . == "False." ~ FALSE))) %>% 
  mutate(across(ends_with("_calls"), as.integer))
#
bb <- aa <- c33churn
```

- Churn (attrition)
  - It is a term used to indicate a customer leaving the service of one company in favour of another company. 
  - The data set contains 20 predictors worth of information about 3333 customers, along with the target variable, churn, an indication of whether that customer churned (left the company) or not.
- Description [3333, 21]
  - State: Categorical, for the 50 states and the District of Columbia. 
  - Account length: Integer-valued, how long account has been active. 
  - Area code: Categorical 
  - Phone number: Essentially a surrogate for customer ID. 
  - International plan: Dichotomous categorical, yes or no. 
  - Voice mail plan: Dichotomous categorical, yes or no. 
  - Number of voice mail messages: Integer-valued. 
  - Total day minutes: Continuous, minutes customer used service during the day. 
  - Total day calls: Integer-valued. 
  - Total day charge: Continuous, perhaps based on above two variables. 
  - Total eve minutes: Continuous, minutes customer used service during the evening. 
  - Total eve calls: Integer-valued. 
  - Total eve charge: Continuous, perhaps based on above two variables. 
  - Total night minutes: Continuous, minutes customer used service during the night. 
  - Total night calls: Integer-valued. 
  - Total night charge: Continuous, perhaps based on above two variables. 
  - Total international minutes: Continuous, minutes customer used service to make international calls. 
  - Total international calls: Integer-valued. 
  - Total international charge: Continuous, perhaps based on above two variables. 
  - Number of calls to customer service: Integer-valued. 
  - Churn: Target. Indicator of whether the customer has left the company (True or False)

## Basics, Skewness & Normality

```{r 'C33-Normality', include=FALSE}
bb <- aa <- c33churn
#str(bb)
ii <- bb %>% select(2, 7:20) %>% 
  relocate(vmail_message, .after = last_col()) %>% 
  relocate(account_length, .after = last_col()) %>% 
  pivot_longer(everything(), names_to = "Key", values_to = "Values") %>% 
  mutate(across(Key, factor, levels = unique(Key)))
#
#str(ii)
#levels(ii$Key)
#
jj <- ii %>% group_by(Key) %>% 
  summarise(Min = min(Values), Max = max(Values), SD = sd(Values), 
            Mean = mean(Values), Median = median(Values), Mode = f_getMode(Values),
            Unique = length(unique(Values)), isNA = sum(is.na(Values)), 
            Skewness = skewness(Values), 
            p_Shapiro = shapiro.test(Values)$p.value, 
            isNormal = ifelse(p_Shapiro > 0.05, TRUE, FALSE))
#
kk <- jj %>% 
  mutate(across(where(is.numeric), round, digits = 4)) %>% 
  mutate(across(where(is.numeric), format, digits = 3, nsmall = 0, 
                replace.zero = TRUE, zero.print = "0", scientific = FALSE, drop0trailing = TRUE)) 
```

```{r 'C33T01', echo=FALSE}
kbl(kk,
  caption = "(C33T01) Churn: Normality",
  #col.names = displ_names,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) %>% 
# #Conditional Row Text Highlight. Background etc. can also be done.
  row_spec(which(!kk$isNormal), color = "red") # %>% row_spec(which(kk$isNormal), color = "black")
```

## Explore Categorical Variables

### International Plan

```{r 'C33-SetIntl', include=FALSE}
# #xyw: x (independent), y (dependent), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer), 
r_xyg <- "International"
c_xyg <- "Churn"
xyg <- bb %>% select(int_l_plan, churn) %>% rename(Predictor = 1, Target = 2) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(Predictor, Target) 
#
str(xyg)
```

```{r 'C33-CrossIntl', echo=FALSE, ref.label=c('C33-CrossTab')}
#
```

#### Contingency Table (CrossTab) {.unlisted .unnumbered}

- 28.4% of churners belong to the International Plan, compared to 6.5% of non-churners.
- 42.4% of the International Plan holders churned, as compared to only 11.5% of those without the International Plan.
- The proportion of International Plan holders is greater among the churners.
- Summary
  - We should investigate what is it about our international plan that is inducing our customers to leave
  - We should expect that, the model (in future) will probably include whether or not the customer selected the International Plan.

```{r 'C33-SetCrossIntl', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T02) ", r_xyg, " vs. ", c_xyg)
```


```{r 'C33T02', echo=FALSE, ref.label=c('C33-CrossKbl')}
#
```

#### Bar Charts {.unlisted .unnumbered .tabset .tabset-fade}

- Bar Charts
  - Grouped 
    - These are good for comparing between each element in the categories, and comparing elements across categories.
  - Stacked 
    - They are great for showing the total because they visually aggregate all of the categories in a group. 
    - The downside is that it becomes harder to compare the sizes of the individual categories. 
    - Stacking also indicates a part to whole relationship.
  - Stacked Percent
    - The total quantity is hidden by using percentages, but it is easier to see the relative difference between quantities in each group.
  - Summary
    - If there is no part to whole relationship (maybe there is overlap in the categories), then grouped
    - If there is a part to whole relationship, then the next question to ask is what relationship is the most important to show. 
      - If the goal is to show sizes between individual categories, use a grouped column or bar chart. 
      - If the goal is to show the total sizes of groups, use a regular stacked bar chart. 
      - If the goal is to show relative differences within each group, use a stacked percentage column chart.

```{conjecture 'stat-count-xy'}
\textcolor{brown}{Error: stat_count() can only have an x or y aesthetic.}
```

```{conjecture 'stat-count-y'}
\textcolor{brown}{Error: stat_count() must not be used with a y aesthetic.}
```

- \textcolor{pink}{stat_count()} Based on the data, choose stat 
  - stat = 'identity' tells ggplot2 that you will provide the y-values (i.e. Wide Data)
  - stat = 'count' is the default, which implies that ggplot2 will count the aggregate number of rows for each x value. (i.e. Long Data)

```{r 'C33-BarGroupIplan', include=FALSE}
# #Grouped Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
cap_hh <- "C33P01"
ttl_hh <- "Churn: Grouped Bar: International Plan vs. Churn"
sub_hh <- NULL 
x_hh <- "International Plan" #r_xyg
y_hh <- "Frequency"
lgd_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5, 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.5, .95), 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P01-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P01", "-Churn-Bar-Intl", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P01, device = "png", dpi = 144) 
}
```

```{r 'C33P01', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P01", "-Churn-Bar-Intl", ".png"))
```

```{r 'C33-BarStackIplan', include=FALSE}
# #Stacked Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
cap_hh <- "C33P02"
ttl_hh <- "Churn: Stacked Bar: International Plan vs. Churn"
sub_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "stack", stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.9, .9)) +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P02-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P02", "-Churn-Stack-Intl", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P02, device = "png", dpi = 144) 
}
```

```{r 'C33P02', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P02", "-Churn-Stack-Intl", ".png"))
```


```{r 'C33-BarPStackIplan', include=FALSE}
# #Percent Stacked Bar Chart
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
cap_hh <- "C33P03"
ttl_hh <- "Churn: Percent Stacked Bar: International Plan vs. Churn"
sub_hh <- NULL 
x_hh <- "International Plan"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "fill", stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = rep(c("black", "white"), 2)) +
    scale_fill_viridis_d(direction = -1) +	
    scale_y_continuous(labels = percent) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P03-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P03", "-Churn-pStack-Intl", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P03, device = "png", dpi = 144) 
}
```

```{r 'C33P03', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P03", "-Churn-pStack-Intl", ".png"))
```

##### Image {.unlisted .unnumbered}

```{r 'C33P010203', echo=FALSE, out.width='33%', ref.label=c('C33P01', 'C33P02', 'C33P03'), fig.cap="(C33P01 C33P02 C33P03) International Plan holders tend to churn more frequently"}
#
```

##### Code CrossTab {.unlisted .unnumbered}

```{r 'C33-SetIntl-A', eval=FALSE, ref.label=c('C33-SetIntl')}
#
```


```{r 'C33-CrossTab', eval=FALSE}
# #IN: xyg (Predictor, Target), r_xyg, c_xyg 
# #Generate Contingency Table (CrossTab)
ctab <- xyg %>% 
  pivot_wider(names_from = Target, values_from = n, values_fill = 0, names_sort = TRUE) %>%
  #mutate(across(1, as.character)) %>% 
  add_row(summarise(., across(1, ~ "Total")), summarise(., across(where(is.numeric), sum))) %>% 
  mutate(SUM = rowSums(across(where(is.numeric)))) %>% 
  mutate(across(where(is.numeric) & !matches("SUM"), 
                list(r = ~ round(. /SUM, 3)), .names = "xx_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !matches("SUM"), 
                list(rp = ~ paste0(round(100 * . /SUM, 1), "%")), .names = "{.fn}{.col}")) %>%
  mutate(across(where(is.numeric) & !starts_with("xx_"), 
                list(c = ~ 2 * ./sum(.)), .names = "yy_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !starts_with("yy_"), 
                list(cp = ~ paste0(round(100 * 2 * . /sum(.), 1), "%")), .names = "{.fn}{.col}"))
```

##### Code CrossTab Print {.unlisted .unnumbered}


```{r 'C33-SetCrossIntl-A', eval=FALSE, ref.label=c('C33-SetCrossIntl')}
#
```


```{r 'C33-CrossKbl', eval=FALSE}
#
kbl(hh,
  caption = cap_hh,
  col.names = names_hh,
  escape = FALSE, align = "c", booktabs = TRUE
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                html_font = "Consolas",	font_size = 12,
                full_width = FALSE,
                #position = "float_left",
                fixed_thead = TRUE
  ) %>%
# #Header Row Dark & Bold: RGB (48, 48, 48) =HEX (#303030)
	row_spec(0, color = "white", background = "#303030", bold = TRUE,
	         extra_css = "border-bottom: 1px solid; border-top: 1px solid"
	) #%>% row_spec(row = 1:nrow(hh), color = "black")
```

### Voice Mail Plan

```{r 'C33-SetVmail', include=FALSE}
# #xyw: x (independent), y (dependent), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer), 
r_xyg <- "VoiceMail"
c_xyg <- "Churn"
xyg <- bb %>% select(vmail_plan, churn) %>% rename(Predictor = 1, Target = 2) %>% 
  mutate(across(1:2, ~ifelse(., 'Yes', 'No'))) %>% 
  count(Predictor, Target) 
#
str(xyg)
```

```{r 'C33-CrossVmail', echo=FALSE, ref.label=c('C33-CrossTab')}
#
```


#### Contingency Table (CrossTab) {.unlisted .unnumbered}

- 16.7% of those without the Voice Mail Plan are churners, as compared to 8.7% of customers who do have the Voice Mail Plan. 
  - Thus, customers without the Voice Mail Plan are nearly twice as likely to churn as customers with the plan.
- Summary
  - Perhaps we should enhance our Voice Mail Plan still further, or make it easier for customers to join it, as an instrument for increasing customer loyalty
  - We should expect that, the model (in future) will probably include whether or not the customer selected the Voice Mail Plan. Our confidence in this expectation is perhaps not quite as high as for the International Plan

```{r 'C33-SetCrossVmail', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T03) ", r_xyg, " vs. ", c_xyg)
```


```{r 'C33T03', echo=FALSE, ref.label=c('C33-CrossKbl')}
#
```

### Three Categorical Variables {.tabset .tabset-fade}

- Two-way interactions among categorical variables with respect to churn. 
  - Multilayer clustered bar chart of churn, clustered by both International Plan and Voice Mail Plan. 
    - There are many more customers who have neither plan. 
    - There are many more customers who have the voice mail plan only than have both plans. 
    - More importantly, among customers with no voice mail plan, the proportion of churners is greater for those who do have an international plan (43.7%) than for those who do not (13.9%).
    - Again, however, among customers with the voice mail plan, the proportion of churners is much greater for those who also select the international plan (39.1%) than for those who do not (5.3%).
    - Note also that there is no interaction among the categorical variables. That is, international plan holders have greater churn regardless of whether they are Voice Mail plan adopters or not.

```{r 'C33-ThreeCat', include=FALSE}
xsyg <- bb %>% select(int_l_plan, vmail_plan, churn) %>% 
  rename(Intl = 1, Vmail =2, Churn = 3) %>% 
  mutate(across(Churn, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Intl, ~ifelse(., "I: Yes", "I: No"))) %>% 
  mutate(across(Vmail, ~ifelse(., "V: Yes", "V: No"))) %>% 
  count(Intl, Vmail, Churn) %>% rename(N = n)
```

```{r 'C33-BarMultiCatMultiFacet', include=FALSE}
# #Multilayer Clustered Bar Chart
hh <- xsyg
#
cap_hh <- "C33P04"
ttl_hh <- "Churn: Churn vs. International & Voice Mail Plans"
sub_hh <- NULL 
x_hh <- "Churn" #r_xyg
y_hh <- "Frequency"
lgd_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Churn, y = N, fill = Churn)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N)) +
    facet_wrap(Intl ~ Vmail, nrow = 1) +
    scale_fill_manual(values = c('#FFEA46FF', '#787877FF')) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = 'top', 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P04-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P04", "-Churn-MultiClusterBar", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P04, device = "png", dpi = 144) 
}
```

```{r 'C33P04', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P04", "-Churn-MultiClusterBar", ".png"))
```


```{r 'C33-BarMultiCatSingleFacet', include=FALSE}
# #Multilayer Clustered Bar Chart
hh <- xsyg
#
cap_hh <- "C33P05"
ttl_hh <- "Churn: Churn vs. International & Voice Mail Plans"
sub_hh <- NULL 
x_hh <- NULL #"Churn" #r_xyg
y_hh <- "Frequency"
lgd_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Vmail, y = N, fill = Churn)) + 
    geom_bar(position = "dodge", stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5) +
    facet_wrap(~Intl, nrow = 1) +
    scale_fill_manual(values = c('#FFEA46FF', '#787877FF')) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = 'top', 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = NULL, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P05-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P05", "-Churn-MultiClusterBarSingleFacet", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P05, device = "png", dpi = 144) 
}
```

```{r 'C33P05', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P05", "-Churn-MultiClusterBarSingleFacet", ".png"))
```

#### Image {.unlisted .unnumbered}

```{r 'C33P0405', echo=FALSE, ref.label=c('C33P04', 'C33P05'), fig.cap="(C33P04 C33P05) Churn vs. International & Voice Mail Plans (Both are Same Graphs)"}
#
```


```{r 'C33-BarPStackIplanMulti', include=FALSE}
# #Percent Stacked Bar Chart
hh <- xsyg %>% group_by(Vmail, Intl) %>% 
    mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
cap_hh <- "C33P06"
ttl_hh <- "Churn: Churn vs. International & Voice Mail Plans"
sub_hh <- NULL 
x_hh <- "Voice Mail"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Vmail, y = N, fill = Churn)) + 
        geom_bar(position = "fill", stat = 'identity') + 
        facet_wrap(~Intl, nrow = 1) +
        geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = rep(c("black", "white"), 4)) +
        scale_fill_viridis_d(direction = -1) +	
        scale_y_continuous(labels = percent) +
        theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
              panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
        labs(x = x_hh, y = y_hh, fill = lgd_hh, 
            subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P06-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P06", "-Churn-pStack-Multi", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P06, device = "png", dpi = 144) 
}
```

```{r 'C33P06', echo=FALSE, fig.cap="(C33P06) Churn vs. International & Voice Mail Plans (Proportional Stack)"}
include_graphics(paste0(".", "/images/", "C33P06", "-Churn-pStack-Multi", ".png"))
```


#### Code {.unlisted .unnumbered}

```{r 'C33-ThreeCat-A', eval=FALSE, ref.label=c('C33-ThreeCat')}
#
```

```{r 'C33-BarMultiCatMultiFacet-A', eval=FALSE, ref.label=c('C33-BarMultiCatMultiFacet')}
#
```

```{r 'C33-BarMultiCatSingleFacet-A', eval=FALSE, ref.label=c('C33-BarMultiCatSingleFacet')}
#
```

#### Code More {.unlisted .unnumbered}

```{r 'C33-BarPStackIplanMulti-A', eval=FALSE, ref.label=c('C33-BarPStackIplanMulti')}
#
```

## Exploring Numeric Variables

- Refer figure \@ref(fig:C33P07) & Table \@ref(tab:C33T01)
  - Fields not showing evidence of symmetry include voice mail messages and customer service calls.
  - Voice Mail Messages: Median = 0 
    - Indicating that at least half of all customers had no voice mail messages. 
    - Because fewer than half of the customers select the Voice Mail Plan (27.7%). 
  - Customer Service Calls: Mean = 1.56 > Median = 1
    - It indicates some right-skewness
    - Also indicated by the maximum number of customer service calls (9).

```{r 'C33P07', echo=FALSE, ref.label=c('B18P03'), fig.cap="(B18P03) Churn: All Histograms"}
# #Ref another file chunk
```


### Service Calls {.tabset .tabset-fade}

- Overlay Histogram
  - To explore whether a predictor is useful for predicting the target variable
  - Bars are coloured according to the values of the target variable. 
  - Normalised Histogram
    - Proportions stretched out to enable better contrast
      - Normalized histograms are useful for teasing out the relationship between a numerical predictor and the target. However, data analysts should always provide the companion a non-normalized histogram along with the normalized histogram, because the normalized histogram does not provide any information on the frequency distribution of the variable.
      - Ex: The churn rate for customers logging nine service calls is 100%; but there are only two customers with this number of calls.
    - Customers who have called customer service three times or less have a markedly lower churn rate  than customers who have called customer service four or more times.
- Summary
  - By the third service call, specialized incentives should be offered to retain customer loyalty, because, by the fourth call, the probability of churn increases greatly
  - We should expect that, the model (in future) will probably include the number of customer service calls made by the customer.
  
```{r 'C33-ServCall', include=FALSE}
ii <- bb %>% select(custserv_calls, churn) %>% 
  rename(Churn = 2) %>% 
  mutate(across(Churn, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistServCall', include=FALSE}
# #Histogram Default (Not useful for association of predictor and target)
hh <- ii
ttl_hh <- "Churn: Customer Service Calls"
cap_hh <- "C33P08"
sub_hh <- "Predictor Only" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = '#FDE725FF')) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1) + 
    #stat_bin(bins = length(unique(.[[1]])), aes(y=..count.., label=..count..), 
    #         geom="text", position=position_stack(vjust=0.5)) +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          #legend.position = c(0.5, -0.08), legend.direction = 'horizontal', 
          legend.position = 'none') +
    labs(x = x_hh, y = y_hh, #fill = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P08-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P08", "-Churn-Hist-ServCall", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P08, device = "png", dpi = 144) 
}
```

```{r 'C33P08', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P08", "-Churn-Hist-ServCall", ".png"))
```

```{r 'C33-HistServCallChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
ttl_hh <- "Churn: Customer Service Calls & Churn"
cap_hh <- "C33P09"
sub_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = Churn)) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1) + 
    #stat_bin(bins = length(unique(.[[1]])), aes(y=..count.., label=..count..), 
    #         geom="text", position=position_stack(vjust=0.5)) +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P09-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P09", "-Churn-Hist-ServCall-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P09, device = "png", dpi = 144) 
}
```

```{r 'C33P09', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P09", "-Churn-Hist-ServCall-Churn", ".png")) 
```


```{r 'C33-pHistServCallChurn', include=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
ttl_hh <- "Churn: Customer Service Calls & Churn"
cap_hh <- "C33P10"
sub_hh <- "Proportion of Predictor & Target (Using Histogram)" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
#
# #NOTES: Group wise Proportion i.e. Yes 1, No 1 (Not Each Bin wise)
# #Adding Density automatically converts the y-axis to 'frequency density' not to 'percentage'
# #Both will match when Bin Width =1 but otherwise there will be a mismatch
# #Using y=..density.. scales the histograms so the area under each is 1, or sum(binwidth*y)=1. 
# #So use y = binwidth *..density.. to have y represent the fraction of the total in each bin. 
# #OR aes(y = stat(width*density))
# #OR aes(y = stat(count / sum(count)))
# #Clarification
# # ..count../sum(..count..) each count is divided by the total count
# # ..density.. it is applied to each group independently
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = custserv_calls, fill = Churn)) + 
    geom_histogram(bins = length(unique(.[[1]])), alpha = 1, position = 'fill') + 
    #stat_bin(bins = length(unique(.[[1]])), 
    #         aes(y = c(..count..[..group..==1]/sum(..count..[..group..==1]),
    #                   ..count..[..group..==2]/sum(..count..[..group..==2])), 
    #             label=round(..density.., 2)), geom="text") +
    #stat_bin(bins = length(unique(.[[1]])), 
    #         aes(y=..density.., group = ..group.., 
    #             label=round(..density.., 2)), geom="text") +
    scale_x_continuous(breaks = breaks_pretty()) + 
		#Deprecated : percent_format()
		scale_y_continuous(labels = percent) +
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P10-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P10", "-Churn-pHist-ServCall-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P10, device = "png", dpi = 144) 
}
```

```{r 'C33P10', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P10", "-Churn-pHist-ServCall-Churn", ".png"))
```

#### Image {.unlisted .unnumbered}

```{r 'C33P080910', echo=FALSE, out.width='33%', ref.label=c('C33P08', 'C33P09', 'C33P10'), fig.cap="(C33P08 C33P09 C33P10) Service Calls beyond 3 have signficant increase in Churn"}
#
```


```{r 'C33-pBarServCallChurn', include=FALSE}
# #complete() can be used to add the missing combination but not using it for now
# #NOTE: Bar is easier to include Labels, However Histogram is easier for large number of bins
xyg  <- ii %>% count(custserv_calls, Churn) 
     #%>% complete(custserv_calls, Churn, fill = list(n = 0)) 
hh <- xyg %>% rename(Group = 1, SubGroup = 2, N = 3) %>% 
  group_by(Group) %>% 
  mutate(Ratio = paste0(round(100 * N/sum(N), 1), "%")) %>% ungroup()
#
ttl_hh <- "Churn: Customer Service Calls & Churn"
cap_hh <- "C33P11"
sub_hh <- "Proportion of Predictor & Target (Using Bar)" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Group, y = N, fill = SubGroup)) + 
    geom_bar(position = "fill", stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), 
              aes(label = ifelse(SubGroup == 'No', "", Ratio)), 
              colour = c(rep(c("black", "white"), 9), "white")) +
    scale_fill_viridis_d(direction = -1) +
    scale_x_continuous(breaks = breaks_pretty()) +
    scale_y_continuous(labels = percent) +
    theme(plot.title.position = "panel", axis.title.x = element_blank(), 
          panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P11-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P11", "-Churn-pBar-ServCall-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P11, device = "png", dpi = 144) 
}
```

```{r 'C33P11', echo=FALSE, fig.cap="(C33P11) Churn vs. Service Call Proportions (Bar)"}
include_graphics(paste0(".", "/images/", "C33P11", "-Churn-pBar-ServCall-Churn", ".png")) 
```

#### Code {.unlisted .unnumbered}

```{r 'C33-ServCall-A', eval=FALSE, ref.label=c('C33-ServCall', 'C33-HistServCall', 'C33-HistServCallChurn', 'C33-pHistServCallChurn')}
#
```

#### Code More {.unlisted .unnumbered}

```{r 'C33-pBarServCallChurn-A', eval=FALSE, ref.label=c('C33-pBarServCallChurn')}
#
```

### Day Minutes 

- Summary: Day Minutes
  - High day-users tend to churn at a higher rate. 
  - As the number of day minutes passes 200, we should consider special incentives
  - We should investigate why heavy day-users are tempted to leave
  - We should expect that, the model (in future) will probably include 'day minutes'.

```{r 'C33-pHistDayMins', include=FALSE}
# #Day Minutes
ii <- bb %>% select(day_mins, churn) %>% 
  rename(Predictor = 1, Target = 2) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistDayMinsChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
ttl_hh <- "Churn: Day Minutes & Churn"
cap_hh <- "C33P12"
sub_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
```

```{r 'C33-HistDayMinsChurn-A', include=FALSE, ref.label=c('C33-HistDayMinsChurn', 'C33-Hist')}
#
```

```{r 'C33P12-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P12", "-Churn-Hist-DayMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P12, device = "png", dpi = 144) 
}
```

```{r 'C33P12', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P12", "-Churn-Hist-DayMins-Churn", ".png")) 
```

```{r 'C33-pHistDayMinsChurn', include=FALSE, eval=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
ttl_hh <- "Churn: Day Minutes & Churn"
cap_hh <- "C33P13"
sub_hh <- "Proportion of Predictor & Target" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
```

```{r 'C33-pHistDayMinsChurn-A', include=FALSE, ref.label=c('C33-pHistDayMinsChurn', 'C33-pHist')}
#
```

```{r 'C33P13-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P13", "-Churn-pHist-DayMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P13, device = "png", dpi = 144) 
}
```

```{r 'C33P13', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P13", "-Churn-pHist-DayMins-Churn", ".png"))
```

```{r 'C33P1213', echo=FALSE, ref.label=c('C33P12', 'C33P13'), fig.cap="(C33P12 C33P13) Higher Day Minutes (>200) have higher Churn"}
#
```


```{r 'C33-Hist', include=FALSE, eval=FALSE}
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = Predictor, fill = Target)) + 
    geom_histogram(bins = ifelse(length(unique(.[[1]])) > 50, 50, length(unique(.[[1]]))), 
                   alpha = 1) + 
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```


```{r 'C33-pHist', include=FALSE, eval=FALSE}
# #Histogram (Predictor and Target Proportion)
# #Caution: Warning on Removal of Missing Values has been removed
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = Predictor, fill = Target)) + 
    geom_histogram(bins = ifelse(length(unique(.[[1]])) > 50, 50, length(unique(.[[1]]))), 
                   alpha = 1, position = 'fill', na.rm = TRUE) + 
    scale_x_continuous(breaks = breaks_pretty()) + 
		scale_y_continuous(labels = percent) +
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

### Evening Minutes 

- Summary : Evening Minutes
  - It shows a slight tendency for customers with higher evening minutes to churn. 
  - However, it is inconclusive solely based on graph. 

```{r 'C33-pHistEveMins', include=FALSE}
# #Evening Minutes
ii <- bb %>% select(eve_mins, churn) %>% 
  rename(Predictor = 1, Target = 2) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistEveMinsChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
ttl_hh <- "Churn: Evening Minutes & Churn"
cap_hh <- "C33P14"
sub_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
```

```{r 'C33-HistEveMinsChurn-A', include=FALSE, ref.label=c('C33-HistEveMinsChurn', 'C33-Hist')}
#
```

```{r 'C33P14-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P14", "-Churn-Hist-EveMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P14, device = "png", dpi = 144) 
}
```

```{r 'C33P14', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P14", "-Churn-Hist-EveMins-Churn", ".png")) 
```

```{r 'C33-pHistEveMinsChurn', include=FALSE, eval=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
ttl_hh <- "Churn: Evening Minutes & Churn"
cap_hh <- "C33P15"
sub_hh <- "Proportion of Predictor & Target" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
```

```{r 'C33-pHistEveMinsChurn-A', include=FALSE, ref.label=c('C33-pHistEveMinsChurn', 'C33-pHist')}
#
```

```{r 'C33P15-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P15", "-Churn-pHist-EveMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P15, device = "png", dpi = 144) 
}
```

```{r 'C33P15', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P15", "-Churn-pHist-EveMins-Churn", ".png"))
```

```{r 'C33P1415', echo=FALSE, ref.label=c('C33P14', 'C33P15'), fig.cap="(C33P14 C33P15) (Inconclusive) Slight tendency to Churn with higher Evening Minutes"}
#
```

### Night Minutes 

- Summary : Night Minutes
  - There is no obvious association visible (in graphs) between churn and night minutes 
  - The lack of obvious association at the EDA stage between a predictor and a target variable is not sufficient reason to omit that predictor from the model. 
  - Unless there is a good reason for eliminating the variable before modeling, we should keep them and allow the modeling process to identify which variables are predictive and which are not.

```{r 'C33-pHistNightMins', include=FALSE}
# #Night Minutes
ii <- bb %>% select(night_mins, churn) %>% 
  rename(Predictor = 1, Target = 2) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistNightMinsChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
ttl_hh <- "Churn: Night Minutes & Churn"
cap_hh <- "C33P16"
sub_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
```

```{r 'C33-HistNightMinsChurn-A', include=FALSE, ref.label=c('C33-HistNightMinsChurn', 'C33-Hist')}
#
```

```{r 'C33P16-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P16", "-Churn-Hist-NightMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P16, device = "png", dpi = 144) 
}
```

```{r 'C33P16', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P16", "-Churn-Hist-NightMins-Churn", ".png")) 
```

```{r 'C33-pHistNightMinsChurn', include=FALSE, eval=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
ttl_hh <- "Churn: Night Minutes & Churn"
cap_hh <- "C33P17"
sub_hh <- "Proportion of Predictor & Target" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
```

```{r 'C33-pHistNightMinsChurn-A', include=FALSE, ref.label=c('C33-pHistNightMinsChurn', 'C33-pHist')}
#
```

```{r 'C33P17-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P17", "-Churn-pHist-NightMins-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P17, device = "png", dpi = 144) 
}
```

```{r 'C33P17', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P17", "-Churn-pHist-NightMins-Churn", ".png"))
```

```{r 'C33P1617', echo=FALSE, ref.label=c('C33P16', 'C33P17'), fig.cap="(C33P16 C33P17) No obvious association between Churn and Night Minutes"}
#
```

### International Calls {.tabset .tabset-fade}

- Summary : International Calls
  - There is no obvious association visible (in graphs) between churn and International Calls
  - However: t-test for the difference in mean number of international calls for churners and  non-churners is statistically significant. i.e. Means are Different.
  - NOTE: Hypothesis Testing is NOT part of EDA. It is mentioned here to show that statistically significant association may exist without being obviously visible.

```{r 'C33-pHistIcalls', include=FALSE}
# #International Calls
ii <- bb %>% select(intl_calls, churn) %>% 
  rename(Predictor = 1, Target = 2) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-HistIcallsChurn', include=FALSE}
# #Histogram (Predictor and Target Count)
hh <- ii
ttl_hh <- "Churn: International Calls & Churn"
cap_hh <- "C33P20"
sub_hh <- "Count of Predictor & Target" 
x_hh <- "x"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
```

```{r 'C33-HistIcallsChurn-A', include=FALSE, ref.label=c('C33-HistIcallsChurn', 'C33-Hist')}
#
```

```{r 'C33P20-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P20", "-Churn-Hist-Icalls-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P20, device = "png", dpi = 144) 
}
```

```{r 'C33P20', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P20", "-Churn-Hist-Icalls-Churn", ".png")) 
```

```{r 'C33-pHistIcallsChurn', include=FALSE, eval=FALSE}
# #Histogram (Predictor and Target Proportion)
hh <- ii
ttl_hh <- "Churn: International Calls & Churn"
cap_hh <- "C33P21"
sub_hh <- "Proportion of Predictor & Target" 
x_hh <- "x"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
```

```{r 'C33-pHistIcallsChurn-A', include=FALSE, ref.label=c('C33-pHistIcallsChurn', 'C33-pHist')}
#
```

```{r 'C33P21-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P21", "-Churn-pHist-Icalls-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P21, device = "png", dpi = 144) 
}
```

```{r 'C33P21', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P21", "-Churn-pHist-Icalls-Churn", ".png"))
```

#### Image {.unlisted .unnumbered}

```{r 'C33P2021', echo=FALSE, ref.label=c('C33P20', 'C33P21'), fig.cap="(C33P20 C33P21) No obvious association between Churn and International Calls (But t-test)"}
#
```

#### t-test {.unlisted .unnumbered}

```{r 'C33-IcallTestT'}
# #t-test for difference in Mean of Target Values
str(ii)
# 
# #Variance
var_ii <- var.test(formula = Predictor ~ Target, data = ii)
var_ii
#
isVarEqual <- ifelse(var_ii$p.value > 0.05, TRUE, FALSE)
if(isVarEqual) print("Variances are Equal.") else print("Variances are Different.")
#
# #t-test: Welch 
ha_ii <- "two.sided" #"two.sided", "less", "greater"
#tt_ii <- t.test(Predictor ~ Target, data = ii, alternative = ha_ii, var.equal = isVarEqual)
tt_ii <- t.test(Predictor ~ Target, data = ii, alternative = ha_ii, var.equal = FALSE)
tt_ii
#
alpha <- 0.05
if(any(all(ha_ii == "two.sided", tt_ii$p.value >= alpha / 2), 
       all(ha_ii != "two.sided", tt_ii$p.value >= alpha))) {
    print("Failed to reject H0.")
} else { 
    print("H0 Rejected.")
}
```

### All Histograms {.tabset .tabset-fade}

```{r 'C33-AllNumeric', include=FALSE}
# #All Continuous Predictors and Target (Categorical)
xsy <- bb %>% 
  select(where(is.numeric) | "churn") %>% 
  select(!area_code) %>% 
  relocate(ends_with("_mins")) %>% 
  relocate(ends_with("_calls")) %>% 
  relocate(vmail_message, .after =  last_col()) %>% 
  relocate("churn") %>% rename("Target" = 1) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Target, factor, levels = unique(Target)))
#
xsyl <- xsy %>% pivot_longer(where(is.numeric), names_to = "Predictors", values_to = "Values") %>% 
  mutate(across(Predictors, ~ factor(., levels = unique(Predictors))))
#
#str(ii)
```

```{r 'C33-AllHistograms', include=FALSE}
# #Histogram
hh <- xsyl
ttl_hh <- "Churn: Histograms of All Predictors with Target (Count)"
cap_hh <- "C33P18"
sub_hh <- NULL #"Count of Predictor & Target" 
x_hh <- NULL # "x"
y_hh <- NULL # "Frequency" #"Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = Values, fill = Target)) + 
    geom_histogram(alpha = 1, boundary = 0, #position = position_stack(reverse = TRUE),
        bins = ifelse(length(unique(.$Predictors)) > 50, 50, length(unique(.$Predictors)))) + 
    #geom_histogram(alpha = 1, boundary = 0,
    #    bins = ifelse(nrow(distinct(.[2])) > 50, 50, nrow(distinct(.[2])))) + 
    facet_wrap(~Predictors, nrow = 3, scales = 'free') +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white"), 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P18-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P18", "-Churn-Hist-All-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P18, device = "png", dpi = 144, width = k_width, height = k_height) 
}
```

```{r 'C33-AllpHistograms', include=FALSE}
# #Histogram
hh <- xsyl
ttl_hh <- "Churn: Histograms of All Predictors with Target (Proportion)"
cap_hh <- "C33P19"
sub_hh <- NULL #"Count of Predictor & Target" 
x_hh <- NULL # "x"
y_hh <- NULL # "Frequency" #"Grouped Percentage"
lgd_hh  <- "Churn"
#
# #Caution: Warning on Removal of Missing Values has been removed
# #NOTE: position_fill() normalizes the Bars and is same as 'fill'
# # 
C33 <- hh %>% { ggplot(data = ., mapping = aes(x = Values, fill = Target)) + 
    geom_histogram(alpha = 1, boundary = 0, position = position_fill(), na.rm = TRUE, 
        bins = ifelse(length(unique(.$Predictors)) > 50, 50, length(unique(.$Predictors)))) + 
    #geom_histogram(alpha = 1, boundary = 0,
    #    bins = ifelse(nrow(distinct(.[2])) > 50, 50, nrow(distinct(.[2])))) + 
    facet_wrap(~Predictors, nrow = 3, scales = 'free_x') +
    scale_x_continuous(breaks = breaks_pretty()) + 
    scale_fill_viridis_d(direction = -1) +
    theme(plot.title.position = "panel", 
          strip.text.x = element_text(size = 10, colour = "white"), 
          axis.title.x = element_blank(), 
          legend.position = c(0.5, -0.07), legend.direction = 'horizontal') +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P19-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P19", "-Churn-pHist-All-Churn", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P19, device = "png", dpi = 144, width = k_width, height = k_height) 
}
```

#### Images {.unlisted .unnumbered}

```{r 'C33P18', echo=FALSE, out.width='100%', fig.cap="(C33P18) Histograms of All Predictors with Target (Count)"}
include_graphics(paste0(".", "/images/", "C33P18", "-Churn-Hist-All-Churn", ".png"))
```

```{r 'C33P19', echo=FALSE, out.width='100%', fig.cap="(C33P19) Histograms of All Predictors with Target (Proportion)"}
include_graphics(paste0(".", "/images/", "C33P19", "-Churn-pHist-All-Churn", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'C33-AllNumeric-A', eval=FALSE, ref.label=c('C33-AllNumeric', 'C33-AllHistograms', 'C33-AllpHistograms')}
#
```

## Exploring Multivariate Variables : Scatter plots

### Day minutes & Evenings minutes  {.tabset .tabset-fade}

- Summary:
  - Customers with both high day minutes and high evening minutes, appear to have a higher proportion of churners than records below the line. 

#### Image {.unlisted .unnumbered}

```{r 'C33-MinEveDay', include=FALSE}
ii <- bb %>% select(day_mins, eve_mins, churn)  %>% 
  rename(Target = churn) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-ScatterMinEveDay', include=FALSE}
hh <- ii
ttl_hh <- "Churn: Scatterplot of Evening Minutes and Day Minutes"
cap_hh <- "C33P22"
sub_hh <- NULL #subtitle = TeX(r"(Trendline Equation, $R^{2}$, $\bar{x}$ and $\bar{y}$)")
x_hh <- "Evening Minutes" # "x"
y_hh <- "Day Minutes" # "Frequency" #"Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., aes(x = eve_mins, y = day_mins)) + 
    #geom_smooth(method = 'lm', formula = k_gg_formula, se = FALSE) +
    #geom_point(position = "jitter", aes(colour = Target)) +
    geom_jitter(aes(colour = Target)) +
		scale_colour_viridis_d(alpha = 0.9, direction = -1) +
    theme(panel.grid.minor = element_blank(),
          panel.border = element_blank()) +
    labs(x = x_hh, y = y_hh, colour = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P22-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P22", "-Churn-Scatter-MinEveDay", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P22, device = "png", dpi = 144) 
}
```

```{r 'C33P22', echo=FALSE, fig.cap="(C33P22) Scatterplot of Evening Minutes (X) and Day Minutes (Y) shows a clear separation for Churn at High X and High Y"}
include_graphics(paste0(".", "/images/", "C33P22", "-Churn-Scatter-MinEveDay", ".png"))
```

#### Code {.unlisted .unnumbered}

```{r 'C33-MinEveDay-A', eval=FALSE, ref.label=c('C33-MinEveDay', 'C33-ScatterMinEveDay')}
#
```

### Day minutes & Customer Service Calls  {.tabset .tabset-fade}

- Summary:
  - It indicates a high-churn area in the upper left section of the graph. These records represent customers who have a combination of a high number of customer service calls and a low number of day minutes used. 
  - Note that this group of customers could not have been identified had we restricted ourselves to univariate exploration (exploring variable by single variable). This is because of the interaction between the variables. 
  - In general, customers with higher numbers of customer service calls tend to churn at a higher rate, as we learned earlier in the univariate analysis. However, of these customers with high numbers of customer service calls, those who also have high day minutes are somewhat "protected" from this high churn rate. The customers in the upper right of the scatter plot exhibit a lower churn rate than those in the upper left.

#### Image {.unlisted .unnumbered}

```{r 'C33-ServCallDayMins', include=FALSE}
ii <- bb %>% select(day_mins, custserv_calls, churn)  %>% 
  rename(Target = churn) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No")))
```

```{r 'C33-ScatterServCallDayMins', include=FALSE}
hh <- ii
ttl_hh <- "Churn: Day Minutes and Customer Service Calls"
cap_hh <- "C33P27"
sub_hh <- NULL
x_hh <- "Day Minutes"
y_hh <- "Customer Service Calls"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(data = ., aes(x = day_mins, y = custserv_calls)) + 
    geom_jitter(aes(colour = Target), width = 0.1, height = 0.1) +
    scale_colour_viridis_d(alpha = 0.9, direction = -1) +
    scale_y_continuous(breaks = breaks_pretty()) + 
    theme(panel.grid.minor = element_blank(),
          panel.border = element_blank()) +
    labs(x = x_hh, y = y_hh, colour = lgd_hh,
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P27-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P27", "-Churn-Scatter-ServCallDayMins", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P27, device = "png", dpi = 144) 
}
```

```{r 'C33P27', echo=FALSE, fig.cap="(C33P27) Scatterplot of Day Minutes (X) and Customer Service Calls (Y) shows an interaction effect for Churn"}
include_graphics(paste0(".", "/images/", "C33P27", "-Churn-Scatter-ServCallDayMins", ".png")) #iiii
```

#### Code {.unlisted .unnumbered}

```{r 'C33-ServCallDayMins-A', eval=FALSE, ref.label=c('C33-ServCallDayMins', 'C33-ScatterServCallDayMins')}
#
```


### package:GGally {.tabset .tabset-fade}

#### SPLOM {.unlisted .unnumbered}

- Scatter Plot of Matrices (SPLOM), with bivariate scatter plots below the diagonal, histograms on the diagonal, and the Pearson correlation above the diagonal.

```{r 'C33-GGally-A7', include=FALSE}
hh <- xsy %>% select(1:6, 11, 16) 
ttl_hh <- "GGally: Churn: SPLOM: Calls, Account Length & Voice Mail (7)"
cap_hh <- "C33P23"
sub_hh <- NULL #"Count of Predictor & Target" 
lgd_hh  <- "Churn"
#
```

```{r 'C33-GGally-A7-A', ref.label=c('C33-GGally-A7', 'C33-GGallyHelpers', 'C33-GGallyBiVariate'), include=FALSE}
#
```

```{r 'C33P23-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P23", "-Churn-SPLOM-Calls-7", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P23, device = "png", dpi = 72, width = k_width, height = k_height) 
}
```

```{r 'C33P23', echo=FALSE, out.width='100%', fig.cap="(C33P23) Bivariate Analysis of Calls showing Churn"}
include_graphics(paste0(".", "/images/", "C33P23", "-Churn-SPLOM-Calls-7", ".png"))
```


```{r 'C33-GGally-B9', include=FALSE}
hh <- xsy %>% select(1, 7:10, 12:15) 
ttl_hh <- "GGally: Churn: SPLOM: Minutes and Charges (8)"
cap_hh <- "C33P24"
sub_hh <- NULL #"Count of Predictor & Target" 
lgd_hh  <- "Churn"
#
```

```{r 'C33-GGally-B9-A', ref.label=c('C33-GGally-B9', 'C33-GGallyHelpers', 'C33-GGallyBiVariate'), include=FALSE}
#
```


```{r 'C33P24-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P24", "-Churn-SPLOM-MinsCharges-8", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P24, device = "png", dpi = 72, width = k_width, height = k_height) 
}
```

```{r 'C33P24', echo=FALSE, out.width='100%', fig.cap="(C33P24) Bivariate Analysis of Minutes & Charges showing Churn"}
include_graphics(paste0(".", "/images/", "C33P24", "-Churn-SPLOM-MinsCharges-8", ".png"))
```

#### GGally Bivariate {.unlisted .unnumbered}

```{r 'C33-GGallyBiVariate', eval=FALSE}
# #Assumes Column 1 has Target Variable (Factor)
C33 <- hh %>% { 
  ggpairs(data = ., mapping = aes(colour = Target, fill = Target, alpha = 0.3), 
          columns = 2:ncol(.), 
          lower = list(continuous = f_gg_scatter),
          diag = list(continuous = f_gg_density)) +
    labs(subtitle = sub_hh, caption = cap_hh, title = ttl_hh) 
}
assign(cap_hh, C33)
rm(C33)
```

#### GGally Manual {.unlisted .unnumbered}

```{r 'C33-GGallyHelpers', eval=FALSE}
# #For GGally Manual Functions
f_gg_scatter <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping) +
    geom_jitter(...) +
    scale_colour_viridis_d(direction = -1)
}

f_gg_density  <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping) +
    geom_density(...) +
    scale_fill_viridis_d(direction = -1) + 
	  scale_colour_viridis_d(direction = -1) 
}
```


### package:psych {.tabset .tabset-fade}

#### SPLOM {.unlisted .unnumbered}

```{r 'C33-Psych-A7', include=FALSE}
hh <- xsy %>% select(1:6, 11, 16) 
cap_hh <- "C33P25"
ttl_hh <- "Psych: Churn: SPLOM: Calls, Account Length & Voice Mail (7)"
loc_png <- paste0(.z$PX, "C33P25", "-Churn-SPLOM-Psych-A7", ".png")
```

```{r 'C33-Psych-A7-A', include=FALSE, ref.label=c('C33-PsychPair')}
#
```

```{r 'C33P25', echo=FALSE, out.width='100%', fig.cap="(C33P25) Bivariate Analysis of Calls showing Churn"}
include_graphics(paste0(".", "/images/", "C33P25", "-Churn-SPLOM-Psych-A7", ".png"))
```

```{r 'C33-Psych-B8', include=FALSE}
hh <- xsy %>% select(1, 7:10, 12:15) 
cap_hh <- "C33P26"
ttl_hh <- "Psych: Churn: SPLOM: SPLOM: Minutes and Charges (8)"
loc_png <- paste0(.z$PX, "C33P26", "-Churn-SPLOM-Psych-B8", ".png")
```

```{r 'C33-Psych-B8-A', include=FALSE, ref.label=c('C33-PsychPair')}
#
```

```{r 'C33P26', echo=FALSE, out.width='100%', fig.cap="(C33P26) Bivariate Analysis of Minutes & Charges showing Churn"}
include_graphics(paste0(".", "/images/", "C33P26", "-Churn-SPLOM-Psych-B8", ".png"))
```

#### pairs.panels() {.unlisted .unnumbered}

```{r 'C33-PsychPair', eval=FALSE}
# #IN: hh, cap_hh, ttl_hh, loc_png
if(!file.exists(loc_png)) {
  png(filename = loc_png, width = k_width, height = k_height, units = "in", res = 144) 
  #dev.control('enable') 
  pairs.panels(hh[2:ncol(hh)], smooth = FALSE, jiggle = TRUE, rug = FALSE, ellipses = FALSE, 
               bg = rev(viridis(2))[hh$Target], pch = 21, lwd = 1, cex.cor = 1, cex = 1, 
               gap = 0, main = ttl_hh)
  #title(main = ttl_hh, line = 2, adj = 0)
  title(sub = cap_hh, line = 4, adj = 1)
  C33 <- recordPlot()
  dev.off()
  assign(cap_hh, C33)
  rm(C33)
}
```

## Subset Interesting Datapoints

- Those which were identified by EDA
- Anomalous fields like Area Code which have only 3 values yet it is distributed over all the States

## Binning

- Figure \@ref(fig:C33P11) showed that customers with less than four calls to customer service had a lower churn rate than customers who had four or more calls to customer service. 
  - We may therefore decide to bin the customer service calls variable into two classes, low (fewer than four) and high (four or more).

```{r 'C33-BinnedServCall', include=FALSE}
# #xyw: x (Predictor), y (Target), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer)
r_xyg <- "Service Calls"
c_xyg <- "Churn"
# #Select Relevant | Binning | Rename & Relocate Target | Select Target & Predictor |
# #Relabel Target | Factor Levels Each | Count | Rename N | Group | Ratio | Ungroup |
xyg <- bb %>% select(custserv_calls, churn) %>% 
  mutate(Predictor = ifelse(custserv_calls < 4, "Low", "High")) %>% 
  relocate(Target = 2) %>% select(Target, Predictor) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Target, factor, levels = c("No", "Yes"))) %>% 
  mutate(across(Predictor, factor, levels = c("Low", "High"))) %>% 
  count(Target, Predictor) %>% 
  rename(N = 3) %>% 
  group_by(Predictor) %>% 
  mutate(Ratio = paste0(round(100 * N / sum(N), 1), "%")) %>% 
  ungroup()
```

```{r 'C33-CTab', include=FALSE}
# #IN: xyg (Predictor, Target), r_xyg, c_xyg 
# #Generate Contingency Table (CrossTab)
ctab <- xyg %>% select(1:3) %>% 
  pivot_wider(names_from = Target, values_from = N, values_fill = 0, names_sort = TRUE) %>%
  #mutate(across(1, as.character)) %>% 
  add_row(summarise(., across(1, ~ "Total")), summarise(., across(where(is.numeric), sum))) %>% 
  mutate(SUM = rowSums(across(where(is.numeric)))) %>% 
  mutate(across(where(is.numeric) & !matches("SUM"), 
                list(r = ~ round(. /SUM, 3)), .names = "xx_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !matches("SUM"), 
                list(rp = ~ paste0(round(100 * . /SUM, 1), "%")), .names = "{.fn}{.col}")) %>%
  mutate(across(where(is.numeric) & !starts_with("xx_"), 
                list(c = ~ 2 * ./sum(.)), .names = "yy_{.fn}{.col}")) %>% 
  mutate(across(where(is.numeric) & !starts_with("xx_") & !starts_with("yy_"), 
                list(cp = ~ paste0(round(100 * 2 * . /sum(.), 1), "%")), .names = "{.fn}{.col}"))
```

```{r 'C33-BarGroupServCall', include=FALSE}
# #Grouped Bar Chart
hh <- xyg
#
cap_hh <- "C33P28"
ttl_hh <- "Churn: Customer Service Calls (Binned)"
sub_hh <- NULL 
x_hh <- "Cutomer Service Calls" #r_xyg
y_hh <- "Frequency"
lgd_hh  <- "Churn" #c_xyg
#
C33 <- hh %>% { ggplot(., aes(x = Predictor, y = N, fill = Target)) + 
    geom_bar(position = position_dodge(), stat = "identity", alpha = 1) + 
    geom_text(position = position_dodge(width = 1), aes(label = N), vjust = 1.5, 
              colour = c(rep("black", 2), rep("white", 2))) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.5, .95), 
          legend.box = "horizontal", legend.direction = "horizontal") +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P28-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P28", "-Churn-Bar-ServiceCalls", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P28, device = "png", dpi = 144) 
}
```

```{r 'C33P28', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P28", "-Churn-Bar-ServiceCalls", ".png"))
```

```{r 'C33-BarStackServCall', include=FALSE}
# #Stacked Bar Chart
hh <- xyg
#
cap_hh <- "C33P29"
ttl_hh <- "Churn: Customer Service Calls (Binned)"
sub_hh <- NULL 
x_hh <- "Cutomer Service Calls"
y_hh <- "Frequency"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Predictor, y = N, fill = Target)) + 
    geom_bar(position = position_stack(), stat = "identity", alpha = 1) + 
    geom_text(position = position_stack(vjust = 0.5), aes(label = N), 
              colour = c(rep("black", 2), rep("white", 2))) +
    scale_fill_viridis_d(direction = -1) +	
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = c(.9, .9)) +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P29-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P29", "-Churn-Stack-ServiceCalls", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P29, device = "png", dpi = 144) 
}
```

```{r 'C33P29', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P29", "-Churn-Stack-ServiceCalls", ".png"))
```

```{r 'C33-BarPStackServCall', include=FALSE}
# #Percent Stacked Bar Chart
hh <- xyg 
#
cap_hh <- "C33P30"
ttl_hh <- "Churn: Customer Service Calls (Binned)"
sub_hh <- NULL 
x_hh <- "Cutomer Service Calls"
y_hh <- "Grouped Percentage"
lgd_hh  <- "Churn"
#
C33 <- hh %>% { ggplot(., aes(x = Predictor, y = N, fill = Target)) + 
    geom_bar(position = position_fill(), stat = 'identity') + 
    geom_text(position = position_fill(vjust = 0.5), aes(label = Ratio), 
              colour = c(rep("black", 2), rep("white", 2))) +
    scale_fill_viridis_d(direction = -1) +	
    scale_y_continuous(labels = percent) +
    theme(panel.grid.major.x = element_blank(), axis.line = element_blank(),
          panel.border = element_rect(colour = "black", fill = NA, size = 1)) +
    labs(x = x_hh, y = y_hh, fill = lgd_hh, 
         subtitle = sub_hh, caption = cap_hh, title = ttl_hh)
}
assign(cap_hh, C33)
rm(C33)
```

```{r 'C33P30-Save', include=FALSE}
loc_png <- paste0(.z$PX, "C33P30", "-Churn-pStack-ServiceCalls", ".png")
if(!file.exists(loc_png)) {
  ggsave(loc_png, plot = C33P30, device = "png", dpi = 144) 
}
```

```{r 'C33P30', include=FALSE, fig.cap="This-Caption-NOT-Shown"}
include_graphics(paste0(".", "/images/", "C33P30", "-Churn-pStack-ServiceCalls", ".png"))
```

```{r 'C33P282930', echo=FALSE, out.width='33%', ref.label=c('C33P28', 'C33P29', 'C33P30'), fig.cap="(C33P28 C33P29 C33P30) High Customer Service Calls have major Churn"}
#
```

```{r 'C33-SetCrossServCall', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T04) ", r_xyg, " vs. ", c_xyg)
```

```{r 'C33T04', echo=FALSE, ref.label=c('C33-CrossKbl')}
#
```


- Similarly, Evening Minutes can be given flags (Categorical)
  - Low (<= 160), Medium (160, 240), High (>240)
  - Recall that the baseline churn rate for all customers is 14.49%. The medium group comes in very close to this baseline rate, 14.1%. 
  - However, the High evening minutes group has nearly double the churn proportion (19.5%) compared to the low evening minutes group (10%). 
  - The Chi-square test is significant, meaning that these results are most likely real and not due to chance alone. "ForLater"

```{r 'C33-BinnedEveMins', include=FALSE}
# #xyw: x (Predictor), y (Target), c (column =y), r (row =x)
# #g (grouped), w (wider), l (longer)
r_xyg <- "Evening Minutes"
c_xyg <- "Churn"
# #Select Relevant | Binning | Rename & Relocate Target | Select Target & Predictor |
# #Relabel Target | Factor Levels Each | Count | Rename N | Group | Ratio | Ungroup |
xyg <- bb %>% select(eve_mins, churn) %>% 
    mutate(Predictor = across(eve_mins, cut, 
        breaks = c(min(.), 160, 240, max(.)), 
        include.lowest = TRUE, labels = c("Low", "Medium", "High"))[[1]]) %>% 
  relocate(Target = 2) %>% select(Target, Predictor) %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Target, factor, levels = c("No", "Yes"))) %>% 
  #mutate(across(Predictor, factor, levels = c("Low", "High"))) %>% 
  count(Target, Predictor) %>% 
  rename(N = 3) %>% 
  group_by(Predictor) %>% 
  mutate(Ratio = paste0(round(100 * N / sum(N), 1), "%")) %>% 
  ungroup()
```

```{r 'C33-CTab-EveMins', include=FALSE, ref.label=c('C33-CTab')}
#
```

```{r 'C33-SetCrossEveMins', include=FALSE}
hh <- ctab %>% select(-c(5:6, 9:11)) 
#names_hh <- names(hh)
names_hh <-c(paste0(c_xyg, " ", "$\\rightarrow$", "<br/>", "$\\downarrow$", " ", r_xyg), 
                "No <br/> <br/>", "Yes <br/> <br/>", "Row <br/> SUM", 
                "Row <br/> No %", "Row <br/> Yes %", 
                "Col <br/> No %", "Col <br/> Yes %", "Col <br/> Row SUM %") 
stopifnot(identical(ncol(hh), length(names_hh)))
stopifnot(nrow(hh) < 10)
#
cap_hh <- paste0("(C33T05) ", r_xyg, " vs. ", c_xyg)
```

```{r 'C33T05', include=FALSE, ref.label=c('C33-CrossKbl')}
#
```

## Correlation  {.tabset .tabset-fade}

- The threshold for significance of the correlation coefficient $r$ depends not only on the sample size but also on data mining, where there are a large number of records (over 1000), even small values of r, such as $-0.1 \leq r \leq 0.1$ may be statistically significant. 
  - One should take care to avoid feeding correlated variables to data mining and statistical models. 
  - At best, using correlated variables will overemphasize one data component; at worst, using correlated variables will cause the model to become unstable and deliver unreliable results. 
  - However, just because two variables are correlated does not mean that we should omit one of them.
    - Identify any variables that are perfectly correlated (i.e. r = 1.0 or r = -1.0). Do not retain both variables in the model, but rather omit one. 
    - Identify groups of variables that are correlated with each other. Then, later, during the modeling phase, apply dimension-reduction methods, such as PCA, to these variables.
  - Example: Charge is perfectly correlated to Minutes (For each of Day, Eve, Night, International). Thus it can be eliminated. Thus number of predictors has been reduced from 20 to 16.
  - Correlation coefficient 0.038 between account length and day calls has a small p-value of 0.026, telling us that account length and day calls are positively correlated. We should note this, and prepare to apply the PCA during the modeling phase.
  - "ForLater" - Get Pearson Correlation Coefficient

### ALL Continuous Variables {.unlisted .unnumbered}

```{r 'C33-AllVarNum'}
# #All Continuous Predictors and Target (Categorical)
# #Select Relevant | Binning | Rename & Relocate | Relabel & Factor Target|
xsy <- bb %>% select( (where(is.numeric) & ! "area_code") | "churn") %>% 
  relocate(ends_with("_mins")) %>% 
  relocate(ends_with("_calls")) %>% 
  relocate(vmail_message, .after =  last_col()) %>% 
  relocate(Target = "churn") %>% 
  mutate(across(Target, ~ifelse(., "Yes", "No"))) %>% 
  mutate(across(Target, factor, levels = unique(Target)))
# #
xsyl <- xsy %>% pivot_longer(where(is.numeric), names_to = "Predictors", values_to = "Values") %>% 
  mutate(across(Predictors, ~ factor(., levels = unique(Predictors))))
# #
# #Select All Minutes and All Charges (8)
hh <- xsy %>% select(1, 7:10, 12:15) 
#
ttl_hh <- "GGally: Churn: SPLOM: Minutes and Charges (8)"
cap_hh <- "C33P31"
sub_hh <- NULL #"Count of Predictor & Target" 
lgd_hh  <- "Churn"
```

### GGally {.unlisted .unnumbered}

```{r 'C33-GGallyBiVariate-A', eval=FALSE, ref.label=c('C33-GGallyBiVariate')}
# 
```

### Psych {.unlisted .unnumbered}

```{r 'C33-PsychPair-A', eval=FALSE, ref.label=c('C33-PsychPair')}
# 
```

### chart.Correlation {.unlisted .unnumbered}

```{r 'C33-PerfAnalytics', eval=FALSE}
# #For Reference Only. Only add Histogram at the Diagonal to the Base pairs()
PerformanceAnalytics::chart.Correlation(hh[2:ncol(hh)], histogram = TRUE)
```

### corrplot() vs. corPlot() {.unlisted .unnumbered}

```{r 'C33-CorrPlots', include=FALSE}
ttl_hh <- "corrplot::corrplot (with Clusters) vs. psych::corPlot"
loc_png <- paste0(.z$PX, "C33P31", "-Churn-corrplot-corPlot", ".png")
#
if(!file.exists(loc_png)) {
  # #Two Graphs Side by Side
  png(filename = loc_png, width = k_width, height = k_height, units = "in", res = 144) 
  #dev.control('enable') 
  # #Correlation along with Clusters
  par(mfrow = c(1, 2))
  corrplot::corrplot(cor(hh[2:ncol(hh)]), method = "circle", type = "full", diag = FALSE, 
                     cl.pos = 'n', tl.pos = 'l', addCoef.col = "black", 
                     order = "hclust", hclust.method = "ward.D", addrect = 2, rect.col = 3,
                     rect.lwd = 3, title = NULL, col = RColorBrewer::brewer.pal(3, "BrBG"))
  title(main = ttl_hh, line = 2, adj = 0)
  #
  #corPlot(hh[2:ncol(hh)], upper = TRUE, diag = TRUE, gr = viridis)
  #corPlot(hh[2:ncol(hh)], upper = TRUE, diag = TRUE, gr = cividis)
  psych::corPlot(hh[2:ncol(hh)], upper = TRUE, diag = FALSE, show.legend = FALSE, keep.par = FALSE, 
    gr = colorRampPalette(RColorBrewer::brewer.pal(3, "BrBG")), main = "")
  title(sub = cap_hh, line = 4, adj = 1)
  C33 <- recordPlot()
  dev.off()
  par(mfrow = c(1, 1))
  assign(cap_hh, C33)
  rm(C33)
}
```

```{r 'C33P31', echo=FALSE, out.width='100%', fig.cap="(C33P31) corrplot::corrplot vs. psych::corPlot()"}
include_graphics(paste0(".", "/images/", "C33P31", "-Churn-corrplot-corPlot", ".png")) #iiii
```

## Insights

- The four 'charge' fields are linear functions of the 'minute' fields, and should be omitted. 
- The 'area code' field and/or the 'state' field are anomalous, and should be omitted.
- Customers with the International Plan tend to churn more frequently. 
- Customers with the Voice Mail Plan tend to churn less frequently. 
- Customers with four or more Customer Service Calls churn more than four times as often as the other customers. 
- Customers with both high Day Minutes and high Evening Minutes tend to churn at a higher rate (6 times) than the other customers. 
- Customers with low Day Minutes and high Customer Service Calls churn at a higher rate than the other customers. 
- Customers with lower numbers of International Calls churn at a higher rate than customers with more international calls. 
  

## Validation {.unlisted .unnumbered .tabset .tabset-fade}

```{r 'C33-Cleanup', include=FALSE, cache=FALSE}
f_rmExist(aa, bb, ii, jj, kk, ll, c33churn, C33P01, C33P02, C33P03, cap_hh, hh, lgd_hh, 
          loc_png, sub_hh, ttl_hh, x_hh, xxB16Cars, xxB18Churn, y_hh, c_xyg, ctab, 
          names_hh, r_xyg, xyg, C33P04, C33P05, C33P06, C33P08, C33P09, C33P10, xsyg, C33P11, 
          C33P12, C33P13, C33P14, C33P15, C33P16, C33P17, C33P18, C33P19, xsyl, alpha, C33P20, 
          C33P21, ha_ii, isVarEqual, tt_ii, var_ii, C33P22, C33P23, C33P24, xsy, C33P25, C33P26,
          C33P27, C33P28, C33P29, C33P30, C33P31)
```

```{r 'C33-Validation', include=FALSE, cache=FALSE}
# #SUMMARISED Packages and Objects (BOOK CHECK)
f_()
#
difftime(Sys.time(), k_start)
```

****
